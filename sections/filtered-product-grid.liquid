{%- liquid
  comment
    Use current collection if on a collection page, otherwise use section setting
  endcomment
  if collection != blank
    assign collection_obj = collection
    assign section_title = section.settings.title | default: collection.title | default: 'Products'
  elsif section.settings.collection != blank
    assign collection_handle = section.settings.collection
    assign collection_obj = collections[collection_handle]
    assign section_title = section.settings.title | default: collection_obj.title | default: 'Products'
  else
    assign collection_obj = blank
    assign section_title = section.settings.title | default: 'Products'
  endif
  
  assign products_per_page = section.settings.products_per_page | default: 9
  
  comment
    Calculate price range from collection products
  endcomment
  assign min_price = 0
  assign max_price = 100000
  
  if collection_obj != blank and collection_obj.products.size > 0
    for product in collection_obj.products
      if product.price < min_price or min_price == 0
        assign min_price = product.price
      endif
      if product.price > max_price
        assign max_price = product.price
      endif
    endfor
  endif
-%}

<section class="filtered-product-grid" id="filtered-product-grid-{{ section.id }}" data-section-id="{{ section.id }}">
  <div class="filtered-product-grid__container">
    <div class="filtered-product-grid__layout">
      <!-- Left Sidebar - Filters -->
      <aside class="filtered-product-grid__sidebar">
        <div class="filtered-product-grid__filters">
          <!-- Price Filter -->
          <div class="filter__group">
            <h3 class="filter__title">Price</h3>
            <div class="filter__price-inputs">
              <input 
                type="text" 
                class="filter__price-input" 
                id="price-min-{{ section.id }}"
                value="{{ min_price | money | remove: '.00' }}"
                data-price-min
              >
              <span class="filter__price-separator">To</span>
              <input 
                type="text" 
                class="filter__price-input" 
                id="price-max-{{ section.id }}"
                value="{{ max_price | money | remove: '.00' }}"
                data-price-max
              >
            </div>
            <div class="filter__price-slider" data-price-slider>
              <input 
                type="range" 
                class="filter__slider filter__slider--min" 
                min="{{ min_price }}" 
                max="{{ max_price }}" 
                value="{{ min_price }}"
                data-slider-min
                data-min-price="{{ min_price }}"
                data-max-price="{{ max_price }}"
              >
              <input 
                type="range" 
                class="filter__slider filter__slider--max" 
                min="{{ min_price }}" 
                max="{{ max_price }}" 
                value="{{ max_price }}"
                data-slider-max
                data-min-price="{{ min_price }}"
                data-max-price="{{ max_price }}"
              >
            </div>
          </div>

          <!-- Availability Toggle -->
          <div class="filter__group">
            <label class="filter__toggle">
              <input type="checkbox" class="filter__toggle-input" data-availability-filter>
              <span class="filter__toggle-slider"></span>
              <span class="filter__toggle-label">Only available items</span>
            </label>
          </div>

          <!-- Filter Categories -->
          {%- for block in section.blocks -%}
            {%- if block.type == 'filter_group' -%}
              <div class="filter__group filter__group--collapsible" {{ block.shopify_attributes }}>
                <details class="filter__details">
                  <summary class="filter__summary">
                    <h3 class="filter__title">{{ block.settings.title }}</h3>
                    <svg class="filter__chevron" width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M4 6L8 10L12 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                  </summary>
                  <div class="filter__options">
                    {%- if block.settings.filter_type == 'product_option' -%}
                      {%- assign option_name = block.settings.option_name -%}
                      {%- assign unique_values = '' -%}
                      {%- for product in collection_obj.products -%}
                        {%- for option in product.options_with_values -%}
                          {%- if option.name == option_name -%}
                            {%- for value in option.values -%}
                              {%- unless unique_values contains value -%}
                                {%- assign unique_values = unique_values | append: value | append: ',' -%}
                              {%- endunless -%}
                            {%- endfor -%}
                          {%- endif -%}
                        {%- endfor -%}
                      {%- endfor -%}
                      {%- assign values_array = unique_values | split: ',' -%}
                      {%- for value in values_array -%}
                        {%- if value != blank -%}
                          {%- assign count = 0 -%}
                          {%- for product in collection_obj.products -%}
                            {%- for option in product.options_with_values -%}
                              {%- if option.name == option_name and option.selected_value == value -%}
                                {%- assign count = count | plus: 1 -%}
                              {%- endif -%}
                            {%- endfor -%}
                          {%- endfor -%}
                          <label class="filter__option">
                            <input 
                              type="checkbox" 
                              class="filter__checkbox" 
                              data-filter-option="{{ option_name | handleize }}"
                              data-filter-value="{{ value | handleize }}"
                              value="{{ value }}"
                            >
                            <span class="filter__option-label">
                              {{ value }}{% if count > 0 %}({{ count }}){% endif %}
                            </span>
                          </label>
                        {%- endif -%}
                      {%- endfor -%}
                    {%- elsif block.settings.filter_type == 'product_tag' -%}
                      {%- assign tag_prefix = block.settings.tag_prefix -%}
                      {%- assign unique_tags = '' -%}
                      {%- for product in collection_obj.products -%}
                        {%- for tag in product.tags -%}
                          {%- if tag contains tag_prefix -%}
                            {%- assign tag_value = tag | remove: tag_prefix | strip -%}
                            {%- unless unique_tags contains tag_value -%}
                              {%- assign unique_tags = unique_tags | append: tag_value | append: ',' -%}
                            {%- endunless -%}
                          {%- endif -%}
                        {%- endfor -%}
                      {%- endfor -%}
                      {%- assign tags_array = unique_tags | split: ',' -%}
                      {%- for tag_value in tags_array -%}
                        {%- if tag_value != blank -%}
                          {%- liquid
                            assign count = 0
                            assign full_tag = tag_prefix | append: tag_value
                          -%}
                          {%- for product in collection_obj.products -%}
                            {%- if product.tags contains full_tag -%}
                              {%- assign count = count | plus: 1 -%}
                            {%- endif -%}
                          {%- endfor -%}
                          <label class="filter__option">
                            <input 
                              type="checkbox" 
                              class="filter__checkbox" 
                              data-filter-tag="{{ tag_prefix | handleize }}"
                              data-filter-value="{{ tag_value | handleize }}"
                              value="{{ tag_value }}"
                            >
                            <span class="filter__option-label">
                              {{ tag_value }}{% if count > 0 %}({{ count }}){% endif %}
                            </span>
                          </label>
                        {%- endif -%}
                      {%- endfor -%}
                    {%- elsif block.settings.filter_type == 'vendor' -%}
                      {%- assign unique_vendors = '' -%}
                      {%- for product in collection_obj.products -%}
                        {%- unless unique_vendors contains product.vendor -%}
                          {%- assign unique_vendors = unique_vendors | append: product.vendor | append: ',' -%}
                        {%- endunless -%}
                      {%- endfor -%}
                      {%- assign vendors_array = unique_vendors | split: ',' -%}
                      {%- for vendor in vendors_array -%}
                        {%- if vendor != blank -%}
                          {%- assign count = 0 -%}
                          {%- for product in collection_obj.products -%}
                            {%- if product.vendor == vendor -%}
                              {%- assign count = count | plus: 1 -%}
                            {%- endif -%}
                          {%- endfor -%}
                          <label class="filter__option">
                            <input 
                              type="checkbox" 
                              class="filter__checkbox" 
                              data-filter-vendor
                              data-filter-value="{{ vendor | handleize }}"
                              value="{{ vendor }}"
                            >
                            <span class="filter__option-label">
                              {{ vendor }}{% if count > 0 %} ({{ count }}){% endif %}
                            </span>
                          </label>
                        {%- endif -%}
                      {%- endfor -%}
                    {%- elsif block.settings.filter_type == 'metafield' -%}
                      {%- comment -%} Metafield filtering would require specific metafield setup {%- endcomment -%}
                      <p class="filter__note">Configure metafield filters in theme settings</p>
                    {%- endif -%}
                  </div>
                </details>
              </div>
            {%- endif -%}
          {%- endfor -%}
        </div>
      </aside>

      <!-- Main Content Area -->
      <main class="filtered-product-grid__main">
        <h1 class="filtered-product-grid__title">{{ section_title }}</h1>
        <div class="filtered-product-grid__products" data-product-grid data-collection-handle="{{ collection_obj.handle | default: '' }}" data-min-price="{{ min_price }}" data-max-price="{{ max_price }}">
          {%- if collection_obj != blank and collection_obj.products.size > 0 -%}
            {%- for product in collection_obj.products limit: products_per_page -%}
              <article class="filtered-product-card">
                {%- liquid
                  assign compare_at_price = product.compare_at_price
                  assign price = product.price
                  
                  if compare_at_price > price
                    assign discount_percentage = compare_at_price | minus: price | times: 100 | divided_by: compare_at_price | round
                  endif
                -%}
                {%- if discount_percentage -%}
                  <div class="filtered-product-card__badge">
                    {{ discount_percentage }}% off
                  </div>
                {%- endif -%}

                <a href="{{ product.url }}" class="filtered-product-card__link">
                  <div class="filtered-product-card__image">
                    {%- if product.featured_image != blank -%}
                      <img 
                        src="{{ product.featured_image | image_url: width: 400 }}"
                        alt="{{ product.featured_image.alt | default: product.title }}"
                        width="400"
                        height="300"
                        loading="lazy"
                      >
                    {%- else -%}
                      <div class="filtered-product-card__placeholder">
                        {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                      </div>
                    {%- endif -%}
                  </div>

                  <div class="filtered-product-card__info">
                    <div class="filtered-product-card__header">
                      <h3 class="filtered-product-card__title">{{ product.title }}</h3>
                      {%- if product.metafields.reviews.rating.value -%}
                        <div class="filtered-product-card__rating">
                          {%- assign rating = product.metafields.reviews.rating.value | round -%}
                          {%- for i in (1..5) -%}
                            <svg class="filtered-product-card__star{% if i <= rating %} filtered-product-card__star--filled{% endif %}" width="14" height="14" viewBox="0 0 14 14" fill="none" xmlns="http://www.w3.org/2000/svg">
                              <path d="M7 1L8.5 5H12.5L9 8L10.5 12L7 9.5L3.5 12L5 8L1.5 5H5.5L7 1Z" fill="currentColor"/>
                            </svg>
                          {%- endfor -%}
                          {%- if product.metafields.reviews.rating_count.value -%}
                            <span class="filtered-product-card__rating-count">({{ product.metafields.reviews.rating_count.value }})</span>
                          {%- endif -%}
                        </div>
                      {%- endif -%}
                    </div>

                    <p class="filtered-product-card__description">
                      {{ product.description | strip_html | truncate: 120 }}
                    </p>
                  </div>
                </a>

                <div class="filtered-product-card__footer">
                  <div class="filtered-product-card__price">
                    {{ price | money }}
                  </div>
                  <div class="filtered-product-card__actions">
                    <a href="{{ product.url }}" class="filtered-product-card__btn filtered-product-card__btn--primary">
                      View Details
                    </a>
                    <button type="button" class="filtered-product-card__btn filtered-product-card__btn--secondary" data-add-to-cart data-variant-id="{{ product.selected_or_first_available_variant.id }}">
                      Add to cart
                    </button>
                  </div>
                </div>
              </article>
            {%- endfor -%}
          {%- else -%}
            <p class="filtered-product-grid__empty">No products available in this collection.</p>
          {%- endif -%}
        </div>
      </main>
    </div>
  </div>
</section>

{% stylesheet %}
.filtered-product-grid {
  padding: 40px 0;
  background-color: var(--color-white);
}

.filtered-product-grid__container {
  max-width: var(--container-max);
  margin: 0 auto;
  padding: 0 var(--container-padding);
}

.filtered-product-grid__layout {
  display: grid;
  grid-template-columns: 280px 1fr;
  gap: 40px;
  align-items: start;
}

.filtered-product-grid__sidebar {
  position: sticky;
  top: 100px;
}

.filtered-product-grid__filters {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.filter__group {
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding-bottom: 24px;
  border-bottom: 1px solid #e0e0e0;
}

.filter__group:last-child {
  border-bottom: none;
}

.filter__group--collapsible {
  padding-bottom: 0;
  border-bottom: none;
}

.filter__title {
  font-family: var(--font-heading);
  font-weight: 500;
  font-size: 16px;
  line-height: normal;
  color: var(--color-black);
  margin: 0;
}

.filter__details {
  border-bottom: 1px solid #e0e0e0;
  padding-bottom: 24px;
}

.filter__summary {
  display: flex;
  align-items: center;
  justify-content: space-between;
  list-style: none;
  cursor: pointer;
  gap: 12px;
}

.filter__summary::-webkit-details-marker {
  display: none;
}

.filter__summary::marker {
  display: none;
}

.filter__chevron {
  width: 16px;
  height: 16px;
  flex-shrink: 0;
  transition: transform var(--transition-fast);
  color: var(--color-black);
}

.filter__details[open] .filter__chevron {
  transform: rotate(180deg);
}

.filter__price-inputs {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter__price-input {
  flex: 1;
  padding: 8px 12px;
  font-family: var(--font-body);
  font-size: 14px;
  border: 1px solid var(--color-black);
  border-radius: 4px;
  background-color: var(--color-white);
}

.filter__price-separator {
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--color-black);
}

.filter__price-slider {
  position: relative;
  height: 4px;
  background-color: #e0e0e0;
  border-radius: 2px;
  margin-top: 8px;
}

.filter__slider {
  position: absolute;
  width: 100%;
  height: 4px;
  -webkit-appearance: none;
  appearance: none;
  background: transparent;
  pointer-events: none;
}

.filter__slider::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  background-color: var(--color-blue);
  border: 2px solid var(--color-black);
  border-radius: 50%;
  cursor: pointer;
  pointer-events: all;
  box-shadow: 2px 2px 0px 0px var(--color-black);
}

.filter__slider::-moz-range-thumb {
  width: 16px;
  height: 16px;
  background-color: var(--color-blue);
  border: 2px solid var(--color-black);
  border-radius: 50%;
  cursor: pointer;
  pointer-events: all;
  box-shadow: 2px 2px 0px 0px var(--color-black);
}

.filter__slider--min {
  z-index: 2;
}

.filter__slider--max {
  z-index: 1;
}

.filter__toggle {
  display: flex;
  align-items: center;
  gap: 12px;
  cursor: pointer;
}

.filter__toggle-input {
  display: none;
}

.filter__toggle-slider {
  position: relative;
  width: 44px;
  height: 24px;
  background-color: #e0e0e0;
  border: 1px solid var(--color-black);
  border-radius: 12px;
  transition: background-color var(--transition-fast);
}

.filter__toggle-slider::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 18px;
  height: 18px;
  background-color: var(--color-white);
  border: 1px solid var(--color-black);
  border-radius: 50%;
  transition: transform var(--transition-fast);
  box-shadow: 1px 1px 0px 0px var(--color-black);
}

.filter__toggle-input:checked + .filter__toggle-slider {
  background-color: var(--color-green);
}

.filter__toggle-input:checked + .filter__toggle-slider::after {
  transform: translateX(20px);
}

.filter__toggle-label {
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--color-black);
}

.filter__options {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 16px;
}

.filter__option {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
}

.filter__checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--color-blue);
  border: 1px solid var(--color-black);
}

.filter__option-label {
  font-family: var(--font-body);
  font-size: 14px;
  color: var(--color-black);
}

.filter__note {
  font-family: var(--font-body);
  font-size: 12px;
  color: var(--color-text-secondary);
  font-style: italic;
  margin: 0;
}

.filtered-product-grid__main {
  display: flex;
  flex-direction: column;
  gap: 32px;
}

.filtered-product-grid__title {
  font-family: var(--font-heading);
  font-weight: 500;
  font-size: 32px;
  line-height: normal;
  color: var(--color-black);
  margin: 0;
}

.filtered-product-grid__products {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 24px;
}

.filtered-product-grid__empty {
  grid-column: 1 / -1;
  text-align: center;
  padding: 40px 20px;
  font-family: var(--font-body);
  font-size: 16px;
  color: var(--color-text-secondary);
}

/* Custom Product Card Styles for Filtered Grid */
.filtered-product-card {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 15px;
  padding: 17px;
  background-color: var(--color-white);
  border: 0.5px solid var(--color-black);
  border-radius: 6px;
  box-shadow: 4px 4px 0px 0px var(--color-black);
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.filtered-product-card:hover {
  transform: translate(-2px, -2px);
  box-shadow: 6px 6px 0px 0px var(--color-black);
}

.filtered-product-card__badge {
  position: absolute;
  top: 0;
  left: 0;
  padding: 4px 12px;
  font-family: var(--font-body);
  font-weight: 500;
  font-size: 14px;
  color: var(--color-white);
  background-color: var(--color-blue);
  border-radius: 0 2px 0 0;
  box-shadow: 1px 2px 0px 0.5px var(--color-black);
  z-index: 2;
}

.filtered-product-card__link {
  display: flex;
  flex-direction: column;
  gap: 15px;
  text-decoration: none;
  color: inherit;
}

.filtered-product-card__image {
  position: relative;
  width: 100%;
  aspect-ratio: 1.7;
  overflow: hidden;
}

.filtered-product-card__image img {
  width: 100%;
  height: 100%;
  object-fit: contain;
}

.filtered-product-card__placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--color-gray);
}

.filtered-product-card__placeholder svg {
  width: 60%;
  height: 60%;
  opacity: 0.5;
}

.filtered-product-card__info {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.filtered-product-card__header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
}

.filtered-product-card__title {
  font-family: var(--font-product);
  font-weight: 700;
  font-size: 17px;
  line-height: 1.2;
  color: var(--color-black);
  margin: 0;
}

.filtered-product-card__rating {
  display: flex;
  gap: 2px;
}

.filtered-product-card__star {
  color: var(--color-gray);
}

.filtered-product-card__star--filled {
  color: var(--color-star);
}

.filtered-product-card__rating-count {
  font-family: var(--font-body);
  font-size: 12px;
  color: var(--color-text-secondary);
  margin-left: 4px;
}

.filtered-product-card__description {
  font-family: var(--font-body);
  font-weight: 500;
  font-size: 12px;
  line-height: 1.4;
  color: var(--color-black);
  margin: 0;
}

.filtered-product-card__footer {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.filtered-product-card__price {
  font-family: var(--font-heading);
  font-weight: 700;
  font-size: 18px;
  color: var(--color-black);
  text-align: center;
}

.filtered-product-card__actions {
  display: flex;
  gap: 10px;
}

.filtered-product-card__btn {
  flex: 1;
  padding: 12px 16px;
  font-family: var(--font-heading);
  font-weight: 600;
  font-size: 14px;
  text-align: center;
  text-decoration: none;
  border: 2px solid var(--color-black);
  border-radius: 4px;
  box-shadow: 3px 3px 0px 0px var(--color-black);
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  white-space: nowrap;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.filtered-product-card__btn--primary {
  background-color: var(--color-green);
  color: var(--color-black);
}

.filtered-product-card__btn--secondary {
  background-color: rgba(177, 216, 255, 1);
  color: var(--color-black);
}

.filtered-product-card__btn:hover {
  transform: translate(-2px, -2px);
  box-shadow: 5px 5px 0px 0px var(--color-black);
}

.filtered-product-card__btn:active {
  transform: translate(1px, 1px);
  box-shadow: 1px 1px 0px 0px var(--color-black);
}

@media screen and (max-width: 1200px) {
  .filtered-product-grid__layout {
    grid-template-columns: 240px 1fr;
    gap: 32px;
  }
}

@media screen and (max-width: 992px) {
  .filtered-product-grid__layout {
    grid-template-columns: 1fr;
    gap: 24px;
  }

  .filtered-product-grid__sidebar {
    position: relative;
    top: 0;
  }

  .filtered-product-grid__products {
    grid-template-columns: repeat(2, 1fr);
    gap: 20px;
  }
}

@media screen and (max-width: 768px) {
  .filtered-product-grid {
    padding: 24px 0;
  }

  .filtered-product-grid__container {
    padding: 0 16px;
  }

  .filtered-product-grid__title {
    font-size: 24px;
  }

  .filtered-product-grid__products {
    grid-template-columns: 1fr;
    gap: 16px;
  }

  .filtered-product-card {
    padding: 14px;
    gap: 12px;
    box-shadow: 4px 4px 0px 0px var(--color-black);
  }

  .filtered-product-card:hover {
    transform: translate(-2px, -2px);
    box-shadow: 6px 6px 0px 0px var(--color-black);
  }

  .filtered-product-card__price {
    font-size: 16px;
  }

  .filtered-product-card__btn {
    padding: 10px 14px;
    font-size: 13px;
  }
}

@media screen and (max-width: 576px) {
  .filtered-product-grid__container {
    padding: 0 12px;
  }

  .filtered-product-grid__title {
    font-size: 20px;
  }

  .filtered-product-card {
    padding: 12px;
    gap: 10px;
  }

  .filtered-product-card__title {
    font-size: 15px;
  }

  .filtered-product-card__description {
    font-size: 11px;
  }

  .filtered-product-card__price {
    font-size: 15px;
  }

  .filtered-product-card__btn {
    padding: 10px 12px;
    font-size: 12px;
  }
}

@media screen and (max-width: 480px) {
  .filtered-product-card {
    padding: 10px;
  }

  .filtered-product-card__title {
    font-size: 14px;
  }

  .filtered-product-card__price {
    font-size: 14px;
  }

  .filtered-product-card__btn {
    font-size: 11px;
    padding: 9px 10px;
  }
}
{% endstylesheet %}

{% javascript %}
(function() {
  const sectionElement = document.querySelector('.filtered-product-grid[data-section-id]');
  if (!sectionElement) return;
  
  const section = sectionElement;
  const priceMinInput = section.querySelector('[data-price-min]');
  const priceMaxInput = section.querySelector('[data-price-max]');
  const priceMinSlider = section.querySelector('[data-slider-min]');
  const priceMaxSlider = section.querySelector('[data-slider-max]');
  const availabilityFilter = section.querySelector('[data-availability-filter]');
  const productGrid = section.querySelector('[data-product-grid]');
  const checkboxes = section.querySelectorAll('.filter__checkbox');

  // Get price range from data attributes or sliders
  const minPrice = productGrid ? parseInt(productGrid.dataset.minPrice) || (priceMinSlider ? parseInt(priceMinSlider.dataset.minPrice) : 0) : 0;
  const maxPrice = productGrid ? parseInt(productGrid.dataset.maxPrice) || (priceMaxSlider ? parseInt(priceMaxSlider.dataset.maxPrice) : 100000) : 100000;

  // Format price for display
  function formatPrice(value) {
    return '₹' + parseInt(value).toLocaleString('en-IN');
  }

  // Parse price from display format
  function parsePrice(value) {
    if (typeof value === 'string') {
      return parseInt(value.replace(/[₹,]/g, '')) || 0;
    }
    return parseInt(value) || 0;
  }

  // Update price inputs from sliders
  function updatePriceInputs() {
    if (priceMinSlider && priceMaxSlider && priceMinInput && priceMaxInput) {
      const minValue = parseInt(priceMinSlider.value);
      const maxValue = parseInt(priceMaxSlider.value);
      
      priceMinInput.value = formatPrice(minValue);
      priceMaxInput.value = formatPrice(maxValue);
      
      // Ensure min doesn't exceed max
      if (minValue > maxValue) {
        priceMinSlider.value = maxValue;
        priceMinInput.value = formatPrice(maxValue);
      }
    }
  }

  // Update sliders from inputs
  function updatePriceSliders() {
    if (priceMinInput && priceMaxInput && priceMinSlider && priceMaxSlider) {
      const minValue = parsePrice(priceMinInput.value) || 0;
      const maxValue = parsePrice(priceMaxInput.value) || 100000;
      
      priceMinSlider.value = Math.min(minValue, parseInt(priceMaxSlider.max));
      priceMaxSlider.value = Math.min(maxValue, parseInt(priceMaxSlider.max));
      
      // Ensure min doesn't exceed max
      if (minValue > maxValue) {
        priceMinInput.value = formatPrice(maxValue);
        priceMinSlider.value = maxValue;
      }
    }
  }

  // Filter products based on current filters
  function filterProducts() {
    if (!productGrid) return;

    const products = productGrid.querySelectorAll('.filtered-product-card');
    const currentMinPrice = priceMinSlider ? parseInt(priceMinSlider.value) : minPrice;
    const currentMaxPrice = priceMaxSlider ? parseInt(priceMaxSlider.value) : maxPrice;
    const onlyAvailable = availabilityFilter ? availabilityFilter.checked : false;
    
    // Get selected filter values
    const selectedFilters = {};
    checkboxes.forEach(checkbox => {
      if (checkbox.checked) {
        const filterType = checkbox.dataset.filterOption || checkbox.dataset.filterTag || checkbox.dataset.filterVendor;
        const filterValue = checkbox.dataset.filterValue || checkbox.value;
        
        if (!selectedFilters[filterType]) {
          selectedFilters[filterType] = [];
        }
        selectedFilters[filterType].push(filterValue);
      }
    });

    let visibleCount = 0;

    products.forEach(product => {
      let shouldShow = true;

      // Price filter
      const priceElement = product.querySelector('.filtered-product-card__price');
      if (priceElement) {
        const priceText = priceElement.textContent.trim();
        const productPrice = parsePrice(priceText);
        if (productPrice < currentMinPrice || productPrice > currentMaxPrice) {
          shouldShow = false;
        }
      }

      // Availability filter
      if (onlyAvailable && shouldShow) {
        const addToCartBtn = product.querySelector('[data-add-to-cart]');
        if (addToCartBtn) {
          const variantId = addToCartBtn.dataset.variantId;
          // This would need to check actual availability via API
          // For now, we'll assume all products are available
        }
      }

      // Other filters (would need product data attributes or API calls)
      // This is a simplified version - full implementation would require
      // product data to be available in data attributes

      if (shouldShow) {
        product.style.display = '';
        visibleCount++;
      } else {
        product.style.display = 'none';
      }
    });

    // Show empty state if no products visible
    let emptyState = productGrid.querySelector('.filtered-product-grid__empty');
    if (visibleCount === 0) {
      if (!emptyState) {
        emptyState = document.createElement('p');
        emptyState.className = 'filtered-product-grid__empty';
        emptyState.textContent = 'No products match your filters.';
        productGrid.appendChild(emptyState);
      }
    } else if (emptyState) {
      emptyState.remove();
    }
  }

  // Event listeners
  if (priceMinSlider) {
    priceMinSlider.addEventListener('input', () => {
      updatePriceInputs();
      filterProducts();
    });
  }

  if (priceMaxSlider) {
    priceMaxSlider.addEventListener('input', () => {
      updatePriceInputs();
      filterProducts();
    });
  }

  if (priceMinInput) {
    priceMinInput.addEventListener('blur', () => {
      updatePriceSliders();
      filterProducts();
    });
  }

  if (priceMaxInput) {
    priceMaxInput.addEventListener('blur', () => {
      updatePriceSliders();
      filterProducts();
    });
  }

  if (availabilityFilter) {
    availabilityFilter.addEventListener('change', filterProducts);
  }

  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', filterProducts);
  });

  // Initialize
  updatePriceInputs();
})();
{% endjavascript %}

{% schema %}
{
  "name": "Filtered Product Grid",
  "tag": "section",
  "class": "filtered-product-grid-section",
  "settings": [
    {
      "type": "text",
      "id": "title",
      "label": "Section Title",
      "default": "Products",
      "info": "Leave empty to use collection title"
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select a collection to display products from. If left empty and used on a collection page, it will automatically use the current collection."
    },
    {
      "type": "range",
      "id": "products_per_page",
      "label": "Products per page",
      "min": 6,
      "max": 24,
      "step": 3,
      "default": 9
    }
  ],
  "blocks": [
    {
      "type": "filter_group",
      "name": "Filter Group",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Filter Title",
          "default": "Filter"
        },
        {
          "type": "select",
          "id": "filter_type",
          "label": "Filter Type",
          "options": [
            {
              "value": "product_option",
              "label": "Product Option"
            },
            {
              "value": "product_tag",
              "label": "Product Tag"
            },
            {
              "value": "vendor",
              "label": "Vendor"
            },
            {
              "value": "metafield",
              "label": "Metafield"
            }
          ],
          "default": "product_option"
        },
        {
          "type": "text",
          "id": "option_name",
          "label": "Option Name",
          "info": "For Product Option type: e.g., 'Screen size', 'Ram', 'Operating system'",
          "default": "Size"
        },
        {
          "type": "text",
          "id": "tag_prefix",
          "label": "Tag Prefix",
          "info": "For Product Tag type: e.g., 'brand:' for tags like 'brand:lenovo'",
          "default": "brand:"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Filtered Product Grid",
      "settings": {
        "title": "Laptops",
        "products_per_page": 9
      },
      "blocks": [
        {
          "type": "filter_group",
          "settings": {
            "title": "Screen size",
            "filter_type": "product_option",
            "option_name": "Screen size"
          }
        },
        {
          "type": "filter_group",
          "settings": {
            "title": "Ram",
            "filter_type": "product_option",
            "option_name": "Ram"
          }
        },
        {
          "type": "filter_group",
          "settings": {
            "title": "Brand",
            "filter_type": "vendor"
          }
        },
        {
          "type": "filter_group",
          "settings": {
            "title": "Operating system",
            "filter_type": "product_option",
            "option_name": "Operating system"
          }
        },
        {
          "type": "filter_group",
          "settings": {
            "title": "Internal memory type",
            "filter_type": "product_option",
            "option_name": "Internal memory type"
          }
        },
        {
          "type": "filter_group",
          "settings": {
            "title": "Image refresh rate",
            "filter_type": "product_option",
            "option_name": "Image refresh rate"
          }
        }
      ]
    }
  ]
}
{% endschema %}

{%- comment -%}
  Related Products Section
  Displays a grid of related products based on collection or recommendations
{%- endcomment -%}

{%- liquid
  assign heading = section.settings.heading | default: 'Related Products'
  assign products_to_show = section.settings.products_to_show | default: 4
  assign collection = section.settings.collection
  
  if product != blank
    assign related_products = product.collections.first.products | where: 'available' | limit: products_to_show
  elsif collection != blank
    assign related_products = collections[collection].products | limit: products_to_show
  endif
-%}

<section class="related-products">
  <div class="related-products__container">
    <h2 class="related-products__heading">{{ heading }}</h2>
    
    <div class="related-products__grid">
      {%- if related_products.size > 0 -%}
        {%- for related_product in related_products -%}
          {%- unless related_product.id == product.id -%}
            {%- liquid
              assign compare_price = related_product.compare_at_price
              assign current_price = related_product.price
              assign rating = related_product.metafields.reviews.rating.value | default: 4
            -%}
            <article class="related-product-card">
              <a href="{{ related_product.url }}" class="related-product-card__link">
                <div class="related-product-card__image">
                  {%- if related_product.featured_image != blank -%}
                    <img 
                      src="{{ related_product.featured_image | image_url: width: 400 }}"
                      alt="{{ related_product.featured_image.alt | default: related_product.title }}"
                      width="270"
                      height="340"
                      loading="lazy"
                    >
                  {%- else -%}
                    <div class="related-product-card__placeholder">
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    </div>
                  {%- endif -%}
                </div>
              </a>
              <div class="related-product-card__info">
                <div class="related-product-card__header">
                  <h3 class="related-product-card__title">{{ related_product.title }}</h3>
                  <div class="related-product-card__rating">
                    {%- for i in (1..5) -%}
                      <svg class="related-product-card__star{% if i <= rating %} related-product-card__star--filled{% endif %}" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M6 1L7.3 4.4H11L7.8 6.6L8.9 10L6 7.8L3.1 10L4.2 6.6L1 4.4H4.7L6 1Z" fill="currentColor"/>
                      </svg>
                    {%- endfor -%}
                  </div>
                </div>
                <span class="related-product-card__price">{{ current_price | money }}</span>
              </div>
            </article>
          {%- endunless -%}
        {%- endfor -%}
      {%- else -%}
        <!-- Demo products when no real products exist -->
        {%- assign demo_products = 'Mens Fashion Wear,Women''s Fashion,Wolx Dummy Fashion,Top Wall Digital Clock' | split: ',' -%}
        {%- assign demo_prices = '$43.00,$67.00,$67.00,$51.00' | split: ',' -%}
        {%- assign demo_ratings = '4,5,5,3' | split: ',' -%}
        
        {%- for demo_title in demo_products -%}
          <article class="related-product-card">
            <a href="#" class="related-product-card__link">
              <div class="related-product-card__image">
                <div class="related-product-card__placeholder">
                  {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                </div>
              </div>
            </a>
            <div class="related-product-card__info">
              <div class="related-product-card__header">
                <h3 class="related-product-card__title">{{ demo_title }}</h3>
                <div class="related-product-card__rating">
                  {%- assign demo_rating = demo_ratings[forloop.index0] | plus: 0 -%}
                  {%- for i in (1..5) -%}
                    <svg class="related-product-card__star{% if i <= demo_rating %} related-product-card__star--filled{% endif %}" width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M6 1L7.3 4.4H11L7.8 6.6L8.9 10L6 7.8L3.1 10L4.2 6.6L1 4.4H4.7L6 1Z" fill="currentColor"/>
                    </svg>
                  {%- endfor -%}
                </div>
              </div>
              <span class="related-product-card__price">{{ demo_prices[forloop.index0] }}</span>
            </div>
          </article>
        {%- endfor -%}
      {%- endif -%}
    </div>
  </div>
</section>

{% stylesheet %}
.related-products {
  padding: 60px 0 80px;
  background-color: var(--color-white);
}

.related-products__container {
  max-width: var(--container-max);
  margin: 0 auto;
  padding: 0 var(--container-padding);
}

.related-products__heading {
  font-family: var(--font-heading);
  font-weight: 600;
  font-size: 36px;
  line-height: 1.2;
  color: var(--color-text);
  margin: 0 0 40px 0;
}

.related-products__grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 30px;
}

/* Related Product Card */
.related-product-card {
  display: flex;
  flex-direction: column;
  background-color: var(--color-white);
  border: 1px solid var(--color-black);
  border-radius: var(--radius-md);
  box-shadow: 0px 4px 0px 0px var(--color-black);
  overflow: hidden;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.related-product-card:hover {
  transform: translateY(-4px);
  box-shadow: 0px 8px 0px 0px var(--color-black);
}

.related-product-card__link {
  display: block;
  text-decoration: none;
}

.related-product-card__image {
  width: 100%;
  height: 340px;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(196, 196, 196, 0.2);
}

.related-product-card__image img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  transition: transform var(--transition-base);
}

.related-product-card:hover .related-product-card__image img {
  transform: scale(1.05);
}

.related-product-card__placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: rgba(196, 196, 196, 0.2);
}

.related-product-card__placeholder svg {
  width: 50%;
  height: 50%;
  opacity: 0.3;
}

.related-product-card__info {
  padding: 16px;
}

.related-product-card__header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  gap: 8px;
  margin-bottom: 8px;
}

.related-product-card__title {
  font-family: 'Josefin Sans', var(--font-heading), sans-serif;
  font-weight: 600;
  font-size: 16px;
  line-height: 1.3;
  color: var(--color-text);
  margin: 0;
  flex: 1;
}

.related-product-card__rating {
  display: flex;
  gap: 1px;
  flex-shrink: 0;
}

.related-product-card__star {
  width: 12px;
  height: 12px;
  color: #B2B2B2;
}

.related-product-card__star--filled {
  color: #FFC416;
}

.related-product-card__price {
  font-family: 'Josefin Sans', var(--font-heading), sans-serif;
  font-weight: 400;
  font-size: 13px;
  line-height: 1;
  color: var(--color-text);
}

/* Responsive */
@media screen and (max-width: 1200px) {
  .related-products__grid {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media screen and (max-width: 992px) {
  .related-products__grid {
    grid-template-columns: repeat(2, 1fr);
  }

  .related-product-card__image {
    height: 280px;
  }
}

@media screen and (max-width: 768px) {
  .related-products {
    padding: 40px 0 60px;
  }

  .related-products__heading {
    font-size: 28px;
    margin-bottom: 30px;
  }

  .related-products__grid {
    gap: 20px;
  }

  .related-product-card__image {
    height: 240px;
  }
}

@media screen and (max-width: 576px) {
  .related-products__grid {
    grid-template-columns: 1fr;
  }

  .related-product-card__image {
    height: 280px;
  }
}
{% endstylesheet %}

{% schema %}
{
  "name": "Related Products",
  "tag": "section",
  "class": "related-products-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Related Products"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Products to show",
      "min": 2,
      "max": 8,
      "step": 1,
      "default": 4
    },
    {
      "type": "collection",
      "id": "collection",
      "label": "Collection",
      "info": "Select a collection for related products. Leave empty to use the product's first collection."
    }
  ],
  "presets": [
    {
      "name": "Related Products"
    }
  ]
}
{% endschema %}


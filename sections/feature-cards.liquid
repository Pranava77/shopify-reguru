{%- liquid
  assign bg_image = section.settings.background_image
-%}

<section class="feature-cards bg-grid-pattern"{% if bg_image != blank %} style="background-image: url('{{ bg_image | image_url: width: 1920 }}'); background-size: cover; background-position: center; background-repeat: no-repeat;"{% endif %}>
  <div class="feature-cards__container">
    <div class="feature-cards__carousel" id="feature-carousel-{{ section.id }}">
      <div class="feature-cards__track">
        {%- for block in section.blocks -%}
          <div class="feature-card" {{ block.shopify_attributes }} data-index="{{ forloop.index0 }}">
            <div class="feature-card__bg" style="background-image: url('{{ block.settings.background_image | image_url: width: 400 }}');">
              <div class="feature-card__overlay"></div>
            </div>
            <div class="feature-card__content">
              <h3 class="feature-card__title">{{ block.settings.title }}</h3>
            </div>
            {%- if block.settings.icon_image != blank -%}
              <div class="feature-card__icon">
                <img 
                  src="{{ block.settings.icon_image | image_url: width: 200 }}" 
                  alt="{{ block.settings.title }}"
                  loading="lazy"
                  width="200"
                  height="200"
                >
              </div>
            {%- endif -%}
          </div>
        {%- endfor -%}

        {%- if section.blocks.size == 0 -%}
          {%- assign default_cards = 'RRR Policy|Affordable|Online & Offline Model|Tailored Solutions|Sustainability' | split: '|' -%}
          {%- for card in default_cards -%}
            <div class="feature-card" data-index="{{ forloop.index0 }}">
              <div class="feature-card__bg feature-card__bg--gradient-{{ forloop.index }}">
                <div class="feature-card__overlay"></div>
              </div>
              <div class="feature-card__content">
                <h3 class="feature-card__title">{{ card }}</h3>
              </div>
              <div class="feature-card__icon feature-card__icon--placeholder">
                {%- case forloop.index -%}
                  {%- when 1 -%}
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <text x="20" y="60" font-size="40" font-weight="bold" fill="#1BDE8F">RRR</text>
                    </svg>
                  {%- when 2 -%}
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <circle cx="50" cy="50" r="30" stroke="#1BDE8F" stroke-width="4"/>
                      <text x="35" y="58" font-size="24" fill="#1BDE8F">â‚¹</text>
                    </svg>
                  {%- when 3 -%}
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect x="15" y="30" width="30" height="40" rx="5" fill="#1BDE8F"/>
                      <rect x="55" y="30" width="30" height="40" rx="5" stroke="#1BDE8F" stroke-width="3"/>
                    </svg>
                  {%- when 4 -%}
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M50 20 L80 40 L80 70 L50 90 L20 70 L20 40 Z" stroke="#1BDE8F" stroke-width="3" fill="none"/>
                      <circle cx="50" cy="55" r="15" fill="#1BDE8F"/>
                    </svg>
                  {%- when 5 -%}
                    <svg viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <path d="M50 20 C30 30 25 50 50 80 C75 50 70 30 50 20" fill="#1BDE8F"/>
                      <path d="M50 35 L55 50 L70 50 L58 60 L62 75 L50 65 L38 75 L42 60 L30 50 L45 50 Z" fill="#212844"/>
                    </svg>
                {%- endcase -%}
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}
      </div>
    </div>

    <!-- Carousel Navigation Dots (Mobile Only) -->
    <div class="feature-cards__dots" id="feature-dots-{{ section.id }}">
      {%- assign card_count = section.blocks.size -%}
      {%- if card_count == 0 -%}
        {%- assign card_count = 5 -%}
      {%- endif -%}
      {%- for i in (1..card_count) -%}
        <button 
          class="feature-cards__dot{% if forloop.first %} feature-cards__dot--active{% endif %}" 
          aria-label="Go to slide {{ forloop.index }}"
          data-index="{{ forloop.index0 }}"
        ></button>
      {%- endfor -%}
    </div>
  </div>
</section>

<script>
  (function() {
    const sectionId = '{{ section.id }}';
    const carousel = document.getElementById('feature-carousel-' + sectionId);
    const dotsContainer = document.getElementById('feature-dots-' + sectionId);
    
    if (!carousel || !dotsContainer) return;
    
    const track = carousel.querySelector('.feature-cards__track');
    const dots = dotsContainer.querySelectorAll('.feature-cards__dot');
    const cards = track.querySelectorAll('.feature-card');
    
    // Get gap based on screen size
    const getGap = () => {
      return window.innerWidth <= 768 ? 20 : 46;
    };
    
    // Update active dot based on scroll position
    const updateActiveDot = () => {
      const scrollLeft = track.scrollLeft;
      const cardWidth = cards[0]?.offsetWidth || (window.innerWidth <= 768 ? 180 : 589);
      const gap = getGap();
      const activeIndex = Math.round(scrollLeft / (cardWidth + gap));
      
      dots.forEach((dot, index) => {
        dot.classList.toggle('feature-cards__dot--active', index === activeIndex);
      });
    };
    
    // Scroll to specific card when dot is clicked
    dots.forEach((dot) => {
      dot.addEventListener('click', () => {
        const index = parseInt(dot.dataset.index, 10);
        const cardWidth = cards[0]?.offsetWidth || (window.innerWidth <= 768 ? 180 : 589);
        const gap = getGap();
        const scrollPosition = index * (cardWidth + gap);
        
        track.scrollTo({
          left: scrollPosition,
          behavior: 'smooth'
        });
      });
    });
    
    // Listen for scroll events on the track
    let scrollTimeout;
    track.addEventListener('scroll', () => {
      clearTimeout(scrollTimeout);
      scrollTimeout = setTimeout(updateActiveDot, 50);
    });
    
    // Update on resize
    window.addEventListener('resize', updateActiveDot);
    
    // Initial update
    updateActiveDot();
  })();
</script>

{% stylesheet %}
.feature-cards {
  padding: 60px 0;
}

.feature-cards__container {
  max-width: var(--container-max);
  margin: 0 auto;
  padding: 0 var(--container-padding);
}

.feature-cards__carousel {
  overflow: visible;
}

.feature-cards__track {
  display: flex;
  gap: 46px;
  overflow-x: auto;
  scroll-snap-type: x mandatory;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: thin;
  scrollbar-color: var(--color-gray) transparent;
  padding: 10px 0 20px;
}

.feature-cards__track::-webkit-scrollbar {
  height: 8px;
}

.feature-cards__track::-webkit-scrollbar-track {
  background: transparent;
}

.feature-cards__track::-webkit-scrollbar-thumb {
  background-color: var(--color-gray);
  border-radius: 4px;
}

.feature-card {
  position: relative;
  display: flex;
  justify-content: center;
  align-items: center;
  width: 589px;
  min-width: 589px;
  max-width: 589px;
  aspect-ratio: 0.63;
  border-radius: 8px;
  overflow: visible;
  cursor: pointer;
  transition: transform var(--transition-base);
  flex-shrink: 0;
  scroll-snap-align: start;
}

.feature-card:hover {
  transform: translateY(-5px);
}

.feature-card__bg {
  position: absolute;
  top: 0;
  left: 0;
  right: 15%;
  bottom: 10%;
  border-radius: 8px;
  background-size: cover;
  background-position: center;
  box-shadow: 4px 4px 0px 0px var(--color-black);
  border: 0.5px solid var(--color-black);
}

.feature-card__bg--gradient-1 {
  background: linear-gradient(135deg, #4A90D9 0%, #667eea 100%);
}

.feature-card__bg--gradient-2 {
  background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
}

.feature-card__bg--gradient-3 {
  background: linear-gradient(135deg, #4ECDC4 0%, #44A08D 100%);
}

.feature-card__bg--gradient-4 {
  background: linear-gradient(135deg, #A770EF 0%, #CF8BF3 100%);
}

.feature-card__bg--gradient-5 {
  background: linear-gradient(135deg, #11998E 0%, #38EF7D 100%);
}

.feature-card__overlay {
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
}

.feature-card__content {
  position: absolute;
  top: 15%;
  left: 10%;
  right: 25%;
  z-index: 2;
}

.feature-card__title {
  font-family: var(--font-accent);
  font-weight: 500;
  font-size: 24px;
  line-height: 1.2;
  color: var(--color-white);
  text-shadow: 1px 1px 0px rgba(6, 24, 58, 0.97);
  letter-spacing: 1px;
  text-transform: capitalize;
  margin: 0;
}

.feature-card__icon {
  position: absolute;
  bottom: 0;
  right: 0;
  width: 60%;
  z-index: 3;
}

.feature-card__icon img {
  width: 100%;
  height: auto;
}

.feature-card__icon--placeholder {
  width: 50%;
}

.feature-card__icon--placeholder svg {
  width: 100%;
  height: auto;
}

/* Navigation Dots */
.feature-cards__dots {
  display: flex;
  justify-content: center;
  gap: 10px;
  margin-top: 16px;
  padding: 0 var(--container-padding);
}

.feature-cards__dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: var(--color-navy);
  opacity: 0.3;
  border: none;
  padding: 0;
  cursor: pointer;
  transition: opacity 0.3s ease, transform 0.3s ease;
}

.feature-cards__dot--active {
  opacity: 1;
  transform: scale(1.2);
  background-color: var(--color-navy);
}

.feature-cards__dot:focus {
  outline: 2px solid var(--color-navy);
  outline-offset: 2px;
}

@media screen and (max-width: 1200px) {
  .feature-cards__track {
    gap: 30px;
  }
}

/* Mobile Carousel Styles */
@media screen and (max-width: 768px) {
  .feature-cards {
    padding: 40px 0;
  }

  .feature-cards__container {
    padding: 0;
  }

  .feature-cards__carousel {
    overflow: hidden;
    padding: 0 20px;
  }

  .feature-cards__track {
    display: flex;
    gap: 20px;
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    -ms-overflow-style: none;
    padding: 10px 0 20px;
  }

  .feature-cards__track::-webkit-scrollbar {
    display: none;
  }

  .feature-card {
    scroll-snap-align: start;
    width: calc((100vw - 70px) / 2.5);
    min-width: calc((100vw - 70px) / 2.5);
    max-width: calc((100vw - 70px) / 2.5);
  }

  .feature-card:hover {
    transform: none;
  }

  .feature-card__title {
    font-size: 18px;
  }

  /* Navigation Dots - Mobile padding override */
  .feature-cards__dots {
    padding: 0 20px;
  }
}

@media screen and (max-width: 480px) {
  .feature-card {
    width: calc((100vw - 70px) / 2.5);
    min-width: calc((100vw - 70px) / 2.5);
    max-width: calc((100vw - 70px) / 2.5);
  }

  .feature-card__title {
    font-size: 16px;
  }

  .feature-cards__dot {
    width: 8px;
    height: 8px;
  }
}
{% endstylesheet %}

{% schema %}
{
  "name": "Feature Cards",
  "tag": "section",
  "class": "feature-cards-section",
  "settings": [
    {
      "type": "image_picker",
      "id": "background_image",
      "label": "Background Image"
    }
  ],
  "blocks": [
    {
      "type": "card",
      "name": "Feature Card",
      "settings": [
        {
          "type": "text",
          "id": "title",
          "label": "Title",
          "default": "Feature"
        },
        {
          "type": "image_picker",
          "id": "background_image",
          "label": "Background Image"
        },
        {
          "type": "image_picker",
          "id": "icon_image",
          "label": "Icon Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Feature Cards",
      "blocks": [
        {
          "type": "card",
          "settings": {
            "title": "RRR Policy"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Affordable"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Online & Offline Model"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Tailored Solutions"
          }
        },
        {
          "type": "card",
          "settings": {
            "title": "Sustainability"
          }
        }
      ]
    }
  ]
}
{% endschema %}

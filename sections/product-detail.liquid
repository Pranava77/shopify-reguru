{%- liquid
  if product == blank
    assign product = all_products[section.settings.product] | default: all_products.first
  endif

  assign selected_variant = product.selected_or_first_available_variant
  assign compare_at_price = selected_variant.compare_at_price
  assign price = selected_variant.price
  
  if compare_at_price > price
    assign discount_percentage = compare_at_price | minus: price | times: 100 | divided_by: compare_at_price | round
  endif

  assign product_images = product.images
-%}

<section class="product-detail" id="product-detail-{{ section.id }}">
  <div class="product-detail__container">
    <div class="product-detail__main">
      <!-- Left Column: Product Images -->
      <div class="product-detail__images">
        <div class="product-detail__main-image">
          {%- if product.featured_image != blank -%}
            <img 
              id="product-main-image"
              src="{{ product.featured_image | image_url: width: 800 }}"
              srcset="{{ product.featured_image | image_url: width: 400 }} 400w,
                      {{ product.featured_image | image_url: width: 600 }} 600w,
                      {{ product.featured_image | image_url: width: 800 }} 800w,
                      {{ product.featured_image | image_url: width: 1200 }} 1200w"
              sizes="(max-width: 768px) 100vw, (max-width: 992px) 50vw, 50vw"
              alt="{{ product.featured_image.alt | default: product.title }}"
              width="800"
              height="800"
              loading="eager"
              fetchpriority="high"
            >
          {%- else -%}
            <div class="product-detail__placeholder">
              {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
            </div>
          {%- endif -%}
        </div>
        
        <div class="product-detail__thumbnails">
          {%- for image in product_images limit: 4 -%}
            <button 
              type="button"
              class="product-detail__thumbnail{% if forloop.first %} product-detail__thumbnail--active{% endif %}"
              data-image-index="{{ forloop.index0 }}"
              data-image-id="{{ image.id }}"
              data-image-url="{{ image | image_url: width: 800 }}"
              aria-label="View product image {{ forloop.index }}"
            >
              <img 
                src="{{ image | image_url: width: 200 }}"
                srcset="{{ image | image_url: width: 134 }} 134w,
                        {{ image | image_url: width: 200 }} 200w"
                sizes="134px"
                alt="{{ image.alt | default: product.title }}"
                width="134"
                height="134"
                loading="lazy"
              >
            </button>
          {%- endfor -%}
        </div>
      </div>

      <!-- Right Column: Product Information -->
      <div class="product-detail__info">
        <div class="product-detail__header">
          <h1 class="product-detail__title">{{ product.title }}</h1>
          
          <div class="product-detail__rating">
            {%- if product.metafields.reviews.rating.value -%}
              {%- assign rating = product.metafields.reviews.rating.value -%}
            {%- else -%}
              {%- assign rating = 4.8 -%}
            {%- endif -%}
            
            <div class="product-detail__stars">
              {%- for i in (1..5) -%}
                <svg 
                  class="product-detail__star{% if i <= rating %} product-detail__star--filled{% endif %}" 
                  width="16" 
                  height="16" 
                  viewBox="0 0 16 16" 
                  fill="none" 
                  xmlns="http://www.w3.org/2000/svg"
                >
                  <path d="M8 1L9.5 5H13.5L10 8L11.5 12L8 9.5L4.5 12L6 8L2.5 5H6.5L8 1Z" fill="currentColor"/>
                </svg>
              {%- endfor -%}
            </div>
            
            <span class="product-detail__rating-text">
              {{ rating }} ({{ product.metafields.reviews.rating_count.value | default: 2847 }} reviews)
            </span>
          </div>

          <div class="product-detail__pricing" data-product-pricing data-variant-id="{{ selected_variant.id }}">
            <span class="product-detail__price" data-price>{{ price | money }}</span>
            {%- if compare_at_price > price -%}
              <span class="product-detail__compare-price" data-compare-price>{{ compare_at_price | money }}</span>
              <span class="product-detail__badge" data-discount-badge>{{ discount_percentage }}% OFF</span>
            {%- endif -%}
          </div>
        </div>

        <div class="product-detail__divider"></div>

        <div class="product-detail__description">
          <p>{{ product.description | strip_html | truncate: 200 | default: 'Experience unparalleled sound quality with our premium wireless headphones. Featuring advanced noise cancellation technology, 40-hour battery life, and exceptional comfort for all-day wear. Perfect for music lovers, travelers, and professionals alike.' }}</p>
        </div>

        <!-- Product Options -->
        {%- if product.options_with_values.size > 0 -%}
          {%- for option in product.options_with_values -%}
            <div class="product-detail__options" data-product-option="{{ option.position }}">
              <label class="product-detail__option-label">{{ option.name }}</label>
              <div class="product-detail__option-values">
                {%- for value in option.values -%}
                  {%- liquid
                    assign variant_for_option = blank
                    for variant in product.variants
                      if variant.options[option.position0] == value
                        assign variant_for_option = variant
                        break
                      endif
                    endfor
                  -%}
                  <button 
                    type="button"
                    class="product-detail__option-value{% if variant_for_option.id == selected_variant.id %} product-detail__option-value--active{% endif %}"
                    data-option-position="{{ option.position0 }}"
                    data-option-value="{{ value | escape }}"
                    data-variant-id="{{ variant_for_option.id }}"
                    {% unless variant_for_option.available %}disabled{% endunless %}
                  >
                    {{ value }}
                  </button>
                {%- endfor -%}
              </div>
            </div>
          {%- endfor -%}
        {%- endif -%}

        <!-- Quantity and Add to Cart -->
        <div class="product-detail__purchase">
          <div class="product-detail__quantity-section">
            <label class="product-detail__quantity-label">Quantity</label>
            <div class="product-detail__quantity-controls">
              <div class="product-detail__quantity-selector">
                <button 
                  type="button" 
                  class="product-detail__quantity-btn"
                  data-quantity-decrease
                  aria-label="Decrease quantity"
                >
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M4 8H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
                <input 
                  type="number" 
                  class="product-detail__quantity-input"
                  id="product-quantity-{{ section.id }}"
                  value="1" 
                  min="1"
                  aria-label="Quantity"
                >
                <button 
                  type="button" 
                  class="product-detail__quantity-btn"
                  data-quantity-increase
                  aria-label="Increase quantity"
                >
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M8 4V12M4 8H12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                </button>
              </div>
              
              <button 
                type="button"
                class="product-detail__btn product-detail__btn--add-cart"
                data-add-to-cart
                data-variant-id="{{ selected_variant.id }}"
                {% unless selected_variant.available %}disabled{% endunless %}
              >
                {%- if selected_variant.available -%}
                  Add to cart
                {%- else -%}
                  Sold out
                {%- endif -%}
              </button>
            </div>
          </div>
          
          <button 
            type="button"
            class="product-detail__btn product-detail__btn--buy-now"
            data-buy-now
            data-variant-id="{{ selected_variant.id }}"
            {% unless selected_variant.available %}disabled{% endunless %}
          >
            Buy Now
          </button>
        </div>

        <!-- Service Guarantees -->
        <div class="product-detail__guarantees">
          <div class="product-detail__guarantee">
            <svg class="product-detail__guarantee-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M2.5 8.75L10 2.5L17.5 8.75V16.25C17.5 16.5815 17.3683 16.8995 17.1339 17.1339C16.8995 17.3683 16.5815 17.5 16.25 17.5H3.75C3.41848 17.5 3.10054 17.3683 2.86612 17.1339C2.6317 16.8995 2.5 16.5815 2.5 16.25V8.75Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M7.5 17.5V10H12.5V17.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="product-detail__guarantee-content">
              <p class="product-detail__guarantee-title">Free Shipping</p>
              <p class="product-detail__guarantee-subtitle">On orders over â‚¹50</p>
            </div>
          </div>
          
          <div class="product-detail__guarantee">
            <svg class="product-detail__guarantee-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 18.3333C14.6024 18.3333 18.3333 14.6024 18.3333 10C18.3333 5.39763 14.6024 1.66667 10 1.66667C5.39763 1.66667 1.66667 5.39763 1.66667 10C1.66667 14.6024 5.39763 18.3333 10 18.3333Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 6.66667V10L12.5 12.5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="product-detail__guarantee-content">
              <p class="product-detail__guarantee-title">2 Year Warranty</p>
              <p class="product-detail__guarantee-subtitle">Full coverage</p>
            </div>
          </div>
          
          <div class="product-detail__guarantee">
            <svg class="product-detail__guarantee-icon" width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
              <path d="M1.66667 10H18.3333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 1.66667L15 6.66667L10 11.6667M10 1.66667L5 6.66667L10 11.6667" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
              <path d="M10 11.6667V18.3333" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            <div class="product-detail__guarantee-content">
              <p class="product-detail__guarantee-title">30-Day Returns</p>
              <p class="product-detail__guarantee-subtitle">Money back guarantee</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Tabs Section -->
    {%- if section.settings.show_tabs -%}
    <div class="product-detail__tabs-section" data-tabs-section>
      <div class="product-detail__tabs" role="tablist" aria-label="Product information tabs">
        {%- for block in section.blocks -%}
          {%- if block.type == 'tab' -%}
            <button 
              type="button"
              class="product-detail__tab{% if forloop.first %} product-detail__tab--active{% endif %}"
              data-tab="{{ block.settings.tab_id | default: block.id }}"
              role="tab"
              aria-selected="{% if forloop.first %}true{% else %}false{% endif %}"
              aria-controls="tab-panel-{{ block.settings.tab_id | default: block.id }}"
              id="tab-{{ block.settings.tab_id | default: block.id }}"
              {{ block.shopify_attributes }}
            >
              {{ block.settings.tab_label | default: block.type | capitalize }}
            </button>
          {%- endif -%}
        {%- endfor -%}
      </div>

      <div class="product-detail__tab-content">
        {%- for block in section.blocks -%}
          {%- if block.type == 'tab' -%}
            {%- assign tab_id = block.settings.tab_id | default: block.id -%}
            <div 
              class="product-detail__tab-panel{% if forloop.first %} product-detail__tab-panel--active{% endif %}" 
              data-tab-panel="{{ tab_id }}"
              role="tabpanel"
              aria-labelledby="tab-{{ tab_id }}"
              id="tab-panel-{{ tab_id }}"
              {% unless forloop.first %}aria-hidden="true"{% endunless %}
              {{ block.shopify_attributes }}
            >
              {%- case block.settings.tab_type -%}
                {%- when 'description' -%}
                  <div class="product-detail__description-content">
                    {%- if product.description != blank -%}
                      {{ product.description }}
                    {%- elsif block.settings.fallback_content != blank -%}
                      {{ block.settings.fallback_content }}
                    {%- else -%}
                      <p>{{ 'products.product.no_description' | t | default: 'No description available.' }}</p>
                    {%- endif -%}
                  </div>
                
                {%- when 'specifications' -%}
                  <div class="product-detail__specifications">
                    {%- if block.settings.specifications_content != blank -%}
                      {{ block.settings.specifications_content }}
                    {%- else -%}
                      <div class="product-detail__specs-list">
                        {%- if product.vendor != blank -%}
                          <div class="product-detail__spec-item">
                            <span class="product-detail__spec-label">{{ 'products.product.vendor' | t | default: 'Vendor' }}:</span>
                            <span class="product-detail__spec-value">{{ product.vendor }}</span>
                          </div>
                        {%- endif -%}
                        
                        {%- if product.type != blank -%}
                          <div class="product-detail__spec-item">
                            <span class="product-detail__spec-label">{{ 'products.product.type' | t | default: 'Type' }}:</span>
                            <span class="product-detail__spec-value">{{ product.type }}</span>
                          </div>
                        {%- endif -%}
                        
                        {%- if product.options_with_values.size > 0 -%}
                          {%- for option in product.options_with_values -%}
                            <div class="product-detail__spec-item">
                              <span class="product-detail__spec-label">{{ option.name }}:</span>
                              <span class="product-detail__spec-value">{{ option.values | join: ', ' }}</span>
                            </div>
                          {%- endfor -%}
                        {%- endif -%}
                        
                        {%- if product.weight > 0 -%}
                          <div class="product-detail__spec-item">
                            <span class="product-detail__spec-label">{{ 'products.product.weight' | t | default: 'Weight' }}:</span>
                            <span class="product-detail__spec-value">{{ product.weight | weight_with_unit }}</span>
                          </div>
                        {%- endif -%}
                        
                        {%- if product.metafields.custom.specifications != blank -%}
                          <div class="product-detail__spec-item">
                            <span class="product-detail__spec-label">{{ 'products.product.specifications' | t | default: 'Specifications' }}:</span>
                            <span class="product-detail__spec-value">{{ product.metafields.custom.specifications }}</span>
                          </div>
                        {%- endif -%}
                      </div>
                    {%- endif -%}
                  </div>
                
                {%- when 'custom' -%}
                  <div class="product-detail__custom-content">
                    {%- if block.settings.custom_content != blank -%}
                      {{ block.settings.custom_content }}
                    {%- else -%}
                      <p>{{ 'products.product.no_content' | t | default: 'No content available.' }}</p>
                    {%- endif -%}
                  </div>
              {%- endcase -%}
            </div>
          {%- endif -%}
        {%- endfor -%}
      </div>
    </div>
    {%- endif -%}
  </div>
</section>

{% stylesheet %}
.product-detail {
  padding: 48px 0;
  background-color: rgba(255, 255, 255, 0);
  width: 100%;
  overflow-x: hidden;
}

.product-detail__container {
  max-width: var(--container-max);
  margin: 0 auto;
  padding: 0 var(--container-padding);
  background-color: rgba(255, 255, 255, 0);
  width: 100%;
  overflow-x: hidden;
}

.product-detail__main {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 64px;
  margin-bottom: 64px;
  background-color: rgba(255, 255, 255, 1);
}

@media screen and (max-width: 992px) {
  .product-detail__main {
    grid-template-columns: 1fr;
  }
}

/* Product Images */
.product-detail__images {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.product-detail__main-image {
  width: 100%;
  aspect-ratio: 1;
  background-color: #f3f4f6;
  border-radius: 10px;
  box-shadow: 4px 4px 0px 0px var(--color-black);
  overflow: hidden;
  position: relative;
  max-width: 100%;
}

.product-detail__main-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.product-detail__placeholder {
  width: 100%;
  height: 100%;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--color-gray);
}

.product-detail__thumbnails {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
  justify-content: flex-start;
}

.product-detail__thumbnail {
  width: 134px;
  height: 134px;
  padding: 2px;
  background-color: #f3f4f6;
  border: 1.818px solid transparent;
  border-radius: 10px;
  box-shadow: 2px 2px 0px 0px var(--color-black);
  cursor: pointer;
  transition: border-color var(--transition-fast), transform var(--transition-fast);
  overflow: hidden;
}

.product-detail__thumbnail--active {
  border-color: var(--color-black);
}

.product-detail__thumbnail:hover {
  transform: translate(-1px, -1px);
  box-shadow: 3px 3px 0px 0px var(--color-black);
}

.product-detail__thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 8px;
}

/* Product Information */
.product-detail__info {
  display: flex;
  flex-direction: column;
  gap: 19px;
  width: 100%;
  max-width: 100%;
  overflow-x: hidden;
}

.product-detail__header {
  display: flex;
  flex-direction: column;
  gap: 19px;
}

.product-detail__title {
  font-family: var(--font-heading);
  font-weight: 500;
  font-size: 32px;
  line-height: 24px;
  color: var(--color-black);
  margin: 0;
}

.product-detail__rating {
  display: flex;
  align-items: center;
  gap: 16px;
}

.product-detail__stars {
  display: flex;
  gap: 4px;
}

.product-detail__star {
  width: 16px;
  height: 16px;
  color: #d1d5db;
}

.product-detail__star--filled {
  color: var(--color-star);
}

.product-detail__rating-text {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 16px;
  line-height: 24px;
  color: #4a5565;
}

.product-detail__pricing {
  display: flex;
  align-items: center;
  gap: 21px;
  flex-wrap: wrap;
}

.product-detail__price {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 30px;
  line-height: 36px;
  color: var(--color-black);
}

.product-detail__compare-price {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 20px;
  line-height: 28px;
  color: #6a7282;
  text-decoration: line-through;
}

.product-detail__badge {
  padding: 3px 9px;
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 12px;
  line-height: 16px;
  color: var(--color-white);
  background-color: #d4183d;
  border: 0.909px solid transparent;
  border-radius: 8px;
}

.product-detail__divider {
  height: 1px;
  width: 100%;
  background-color: rgba(0, 0, 0, 0.1);
}

.product-detail__description {
  min-height: 96px;
}

.product-detail__description p {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 16px;
  line-height: 24px;
  color: #4a5565;
  margin: 0;
}

/* Product Options */
.product-detail__options {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.product-detail__option-label {
  font-family: var(--font-heading);
  font-weight: 400;
  font-size: 16px;
  line-height: 24px;
  color: var(--color-black);
}

.product-detail__option-values {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  width: 100%;
}

.product-detail__option-value {
  padding: 8px 21px;
  font-family: var(--font-heading);
  font-weight: 400;
  font-size: 18px;
  line-height: normal;
  color: var(--color-black);
  background-color: var(--color-white);
  border: 0.5px solid var(--color-black);
  border-radius: 6px;
  box-shadow: 4px 4px 0px 0px var(--color-black);
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.product-detail__option-value:hover:not(:disabled) {
  transform: translate(-2px, -2px);
  box-shadow: 6px 6px 0px 0px var(--color-black);
}

.product-detail__option-value:active:not(:disabled) {
  transform: translate(1px, 1px);
  box-shadow: 2px 2px 0px 0px var(--color-black);
}

.product-detail__option-value--active {
  background-color: var(--color-white);
  border-color: var(--color-black);
}

.product-detail__option-value:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* Purchase Section */
.product-detail__purchase {
  display: flex;
  flex-direction: column;
  gap: 13px;
}

.product-detail__quantity-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
  width: 100%;
  max-width: 662px;
}

.product-detail__quantity-label {
  font-family: var(--font-heading);
  font-weight: 600;
  font-size: 16px;
  line-height: 24px;
  color: var(--color-black);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.product-detail__quantity-controls {
  display: flex;
  gap: 19px;
  align-items: center;
  justify-content: center;
  width: 100%;
  max-width: 659px;
  border-radius: 6px;
}

.product-detail__quantity-selector {
  display: flex;
  align-items: center;
  height: 48px;
  width: auto;
  gap: 0;
  border: 2px solid var(--color-black);
  border-radius: 6px;
  box-shadow: 4px 4px 0px 0px var(--color-black);
  background-color: var(--color-white);
  overflow: hidden;
}

.product-detail__quantity-btn {
  width: 48px;
  height: 48px;
  display: flex;
  align-items: center;
  justify-content: center;
  background-color: var(--color-white);
  border: none;
  border-right: 2px solid var(--color-black);
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast);
  color: var(--color-black);
  flex-shrink: 0;
  touch-action: manipulation;
}

.product-detail__quantity-btn:first-child {
  border-right: 2px solid var(--color-black);
  border-top-left-radius: 6px;
  border-bottom-left-radius: 6px;
}

.product-detail__quantity-btn:last-child {
  border-left: 2px solid var(--color-black);
  border-right: none;
  border-top-right-radius: 6px;
  border-bottom-right-radius: 6px;
}

.product-detail__quantity-btn:hover {
  background-color: var(--color-green);
  transform: translate(-2px, -2px);
  box-shadow: 2px 2px 0px 0px var(--color-black);
}

.product-detail__quantity-btn:active {
  transform: translate(0, 0);
  box-shadow: none;
}

.product-detail__quantity-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}

.product-detail__quantity-input {
  flex: 1;
  min-width: 60px;
  height: 100%;
  border: none;
  border-left: 2px solid var(--color-black);
  border-right: 2px solid var(--color-black);
  text-align: center;
  font-family: var(--font-heading);
  font-weight: 600;
  font-size: 18px;
  line-height: 24px;
  color: var(--color-black);
  background-color: var(--color-white);
  -moz-appearance: textfield;
  appearance: textfield;
  outline: none;
}

.product-detail__quantity-input:focus {
  background-color: var(--color-green);
}

.product-detail__quantity-input::-webkit-outer-spin-button,
.product-detail__quantity-input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}

.product-detail__btn {
  padding: 8px 21px;
  font-family: var(--font-heading);
  font-weight: 400;
  font-size: 18px;
  line-height: normal;
  text-align: center;
  border: 0.5px solid var(--color-black);
  border-radius: 6px;
  box-shadow: 4px 4px 0px 0px var(--color-black);
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
  white-space: nowrap;
}

.product-detail__btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.product-detail__btn--loading {
  opacity: 0.7;
  cursor: wait;
  pointer-events: none;
}

.product-detail__btn--add-cart {
  width: 100%;
  max-width: 278px;
  background-color: var(--color-white);
  color: var(--color-black);
  margin-left: auto;
}

.product-detail__btn--buy-now {
  width: 100%;
  background-color: var(--color-green-alt);
  color: var(--color-black);
  font-weight: 600;
  font-size: 24px;
}

.product-detail__btn:hover {
  transform: translate(-2px, -2px);
  box-shadow: 6px 6px 0px 0px var(--color-black);
}

.product-detail__btn:active {
  transform: translate(1px, 1px);
  box-shadow: 2px 2px 0px 0px var(--color-black);
}

/* Service Guarantees */
.product-detail__guarantees {
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  gap: 16px;
  margin-top: 24px;
}

.product-detail__guarantee {
  display: flex;
  align-items: center;
  gap: 12px;
  flex: 1 1 calc(50% - 8px);
  min-width: 150px;
}

.product-detail__guarantee-icon {
  width: 20px;
  height: 20px;
  flex-shrink: 0;
  color: var(--color-black);
}

.product-detail__guarantee-content {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.product-detail__guarantee-title {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 14px;
  line-height: 20px;
  color: var(--color-black);
  margin: 0;
}

.product-detail__guarantee-subtitle {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 12px;
  line-height: 16px;
  color: var(--color-text-secondary);
  margin: 0;
}

/* Tabs Section */
.product-detail__tabs-section {
  display: flex;
  flex-direction: column;
  gap: 40px;
}

.product-detail__tabs {
  display: flex;
  justify-content: center;
  border-bottom: 0.909px solid rgba(0, 0, 0, 0.1);
  position: relative;
}

.product-detail__tab {
  padding: 5px 9px;
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 14px;
  line-height: 20px;
  color: var(--color-black);
  background-color: transparent;
  border: 0.909px solid transparent;
  border-bottom: 1.818px solid transparent;
  border-top: 0.909px solid transparent;
  border-left: 0.909px solid transparent;
  border-right: 0.909px solid transparent;
  border-radius: 6px 6px 0 0;
  cursor: pointer;
  transition: all var(--transition-fast);
  min-width: 0;
  flex: 1;
  text-align: center;
}

.product-detail__tab--active {
  background-color: var(--color-green);
  border-color: var(--color-black);
  border-bottom-color: var(--color-green);
  box-shadow: 4px 4px 0px 0px var(--color-black);
  position: relative;
  z-index: 1;
}

.product-detail__tab-content {
  position: relative;
  min-height: 400px;
  text-align: center;
}

.product-detail__tab-panel {
  display: none;
}

.product-detail__tab-panel--active {
  display: block;
}

.product-detail__tab-panel[aria-hidden="true"] {
  display: none;
}

/* Specifications styling */
.product-detail__specs-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.product-detail__spec-item {
  display: flex;
  align-items: flex-start;
  gap: 16px;
  padding-bottom: 16px;
  border-bottom: 1px solid var(--color-gray);
}

.product-detail__spec-item:last-child {
  border-bottom: none;
  padding-bottom: 0;
}

.product-detail__spec-label {
  font-family: var(--font-heading);
  font-weight: 500;
  font-size: 14px;
  line-height: 1.5;
  color: var(--color-black);
  min-width: 120px;
  flex-shrink: 0;
}

.product-detail__spec-value {
  font-family: var(--font-body);
  font-size: 14px;
  line-height: 1.5;
  color: var(--color-text-secondary);
  flex: 1;
}

/* Custom content styling */
.product-detail__custom-content {
  font-family: var(--font-body);
  font-size: 16px;
  line-height: 1.6;
  color: var(--color-black);
}

.product-detail__custom-content h1,
.product-detail__custom-content h2,
.product-detail__custom-content h3,
.product-detail__custom-content h4,
.product-detail__custom-content h5,
.product-detail__custom-content h6 {
  font-family: var(--font-heading);
  font-weight: 500;
  margin-top: 24px;
  margin-bottom: 12px;
  color: var(--color-black);
}

.product-detail__custom-content h3 {
  font-size: 20px;
}

.product-detail__custom-content p {
  margin-bottom: 16px;
}

.product-detail__custom-content ul,
.product-detail__custom-content ol {
  margin-left: 24px;
  margin-bottom: 16px;
}

.product-detail__custom-content li {
  margin-bottom: 8px;
}

.product-detail__description-content {
  display: flex;
  flex-direction: column;
  gap: 16px;
  max-width: 768px;
}

.product-detail__description-heading {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 18px;
  line-height: 27px;
  color: var(--color-black);
  margin: 0;
}

.product-detail__description-text {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 16px;
  line-height: 24px;
  color: var(--color-text-secondary);
  margin: 0;
}

.product-detail__specifications {
  font-family: var(--font-body);
  font-weight: 400;
  font-size: 16px;
  line-height: 24px;
  color: var(--color-text-secondary);
}

/* Responsive Styles */
@media screen and (min-width: 769px) {
  .product-detail__guarantee {
    flex: 1 1 calc(33.333% - 11px);
  }
}

@media screen and (min-width: 993px) {
  .product-detail__guarantees {
    gap: 0;
  }

  .product-detail__guarantee {
    width: 184px;
    flex: none;
    min-width: auto;
  }
}

@media screen and (max-width: 992px) {
  .product-detail__main {
    gap: 40px;
  }

  .product-detail__thumbnails {
    justify-content: center;
  }

  .product-detail__quantity-section {
    max-width: 100%;
  }

  .product-detail__quantity-controls {
    width: 100%;
    max-width: 100%;
  }

  .product-detail__btn--add-cart {
    max-width: 100%;
    margin-left: 0;
  }

  .product-detail__tab {
    min-width: 0;
    flex: 1;
    font-size: 12px;
    padding: 4px 8px;
  }

  .product-detail__spec-item {
    flex-direction: column;
    gap: 8px;
    align-items: flex-start;
  }

  .product-detail__spec-label {
    min-width: auto;
    font-weight: 600;
  }

  .product-detail__spec-value {
    width: 100%;
  }

  .product-detail__guarantees {
    gap: 12px;
  }

  .product-detail__guarantee {
    flex: 1 1 calc(50% - 6px);
    min-width: calc(50% - 6px);
  }
}

@media screen and (max-width: 768px) {
  .product-detail {
    padding: 32px 0;
  }

  .product-detail__container {
    padding: 0 16px;
  }

  .product-detail__main {
    gap: 32px;
    margin-bottom: 40px;
  }

  .product-detail__title {
    font-size: 24px;
    line-height: 1.2;
  }

  .product-detail__rating {
    flex-wrap: wrap;
    gap: 12px;
  }

  .product-detail__pricing {
    gap: 12px;
    flex-wrap: wrap;
  }

  .product-detail__price {
    font-size: 24px;
    line-height: 28px;
  }

  .product-detail__compare-price {
    font-size: 18px;
    line-height: 22px;
  }

  .product-detail__quantity-section {
    max-width: 100%;
  }

  .product-detail__quantity-controls {
    flex-direction: column;
    gap: 12px;
    width: 100%;
    max-width: 100%;
  }

  .product-detail__quantity-selector {
    width: 100%;
  }

  .product-detail__btn--add-cart {
    width: 100%;
    max-width: 100%;
    margin-left: 0;
  }

  .product-detail__btn--buy-now {
    width: 100%;
  }

  .product-detail__tabs {
    flex-direction: column;
    border-bottom: none;
    gap: 8px;
  }

  .product-detail__tab {
    border: 0.5px solid var(--color-black);
    border-radius: 6px;
    margin-bottom: 0;
    box-shadow: 2px 2px 0px 0px var(--color-black);
    width: 100%;
  }

  .product-detail__tab--active {
    background-color: var(--color-green);
    border-bottom-color: var(--color-green);
    box-shadow: 4px 4px 0px 0px var(--color-black);
  }

  .product-detail__guarantees {
    display: none;
  }
}

@media screen and (max-width: 576px) {
  .product-detail {
    padding: 24px 0;
  }

  .product-detail__container {
    padding: 0 12px;
  }

  .product-detail__title {
    font-size: 20px;
  }

  .product-detail__btn--buy-now {
    font-size: 18px;
  }

  .product-detail__thumbnails {
    gap: 8px;
    justify-content: center;
  }

  .product-detail__thumbnail {
    width: 80px;
    height: 80px;
    flex-shrink: 0;
  }

  .product-detail__guarantees {
    flex-direction: column;
    gap: 12px;
  }

  .product-detail__guarantee {
    flex: 1 1 100%;
    min-width: 100%;
  }

  .product-detail__option-values {
    gap: 8px;
  }

  .product-detail__option-value {
    padding: 6px 16px;
    font-size: 16px;
  }

  .product-detail__main-image {
    aspect-ratio: 1;
  }

  .product-detail__description {
    min-height: auto;
  }

  .product-detail__tab-content {
    min-height: auto;
    text-align: left;
  }
}
{% endstylesheet %}

{%- comment -%} Generate variant and image data as JSON for JavaScript {%- endcomment -%}
<script type="application/json" data-product-variants>
{
  "variants": {
    {%- for variant in product.variants -%}
      "{{ variant.id }}": {
        "id": {{ variant.id }},
        "price": {{ variant.price }},
        "compareAtPrice": {{ variant.compare_at_price | default: 0 }},
        "available": {{ variant.available | json }},
        "options": {{ variant.options | json }},
        "priceFormatted": {{ variant.price | money | json }},
        "comparePriceFormatted": {{ variant.compare_at_price | money | json }},
        "imageId": {% if variant.featured_image %}{{ variant.featured_image.id }}{% else %}null{% endif %},
        "imageUrl": {% if variant.featured_image %}{{ variant.featured_image | image_url: width: 800 | json }}{% else %}null{% endif %}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  },
  "images": [
    {%- for image in product.images -%}
      {
        "id": {{ image.id }},
        "url": {{ image | image_url: width: 800 | json }},
        "thumbnailUrl": {{ image | image_url: width: 200 | json }},
        "alt": {{ image.alt | json }}
      }{% unless forloop.last %},{% endunless %}
    {%- endfor -%}
  ],
  "currentVariantId": {{ selected_variant.id | json }}
}
</script>

{% javascript %}
(function() {
  const productDetail = document.querySelector('.product-detail');
  if (!productDetail) return;

  // Get variant and image data from JSON script tag
  const dataScript = document.querySelector('[data-product-variants]');
  let variantData = {};
  let productImages = [];
  let currentVariantId = null;

  if (dataScript) {
    try {
      const productData = JSON.parse(dataScript.textContent);
      variantData = productData.variants || {};
      productImages = productData.images || [];
      currentVariantId = productData.currentVariantId || null;
    } catch (error) {
      console.error('Error parsing product data:', error);
    }
  }
  const thumbnails = productDetail.querySelectorAll('.product-detail__thumbnail');
  const mainImage = productDetail.querySelector('#product-main-image');
  
  for (const thumbnail of thumbnails) {
    thumbnail.addEventListener('click', function() {
      const imageUrl = this.dataset.imageUrl;
      if (mainImage && imageUrl) {
        mainImage.src = imageUrl;
        
        // Update active state
        thumbnails.forEach(t => t.classList.remove('product-detail__thumbnail--active'));
        this.classList.add('product-detail__thumbnail--active');
      }
    });
  }

  // Quantity controls
  const quantityInput = productDetail.querySelector('.product-detail__quantity-input');
  const decreaseBtn = productDetail.querySelector('[data-quantity-decrease]');
  const increaseBtn = productDetail.querySelector('[data-quantity-increase]');

  if (quantityInput && decreaseBtn && increaseBtn) {
    // Function to update quantity value and button states
    function updateQuantity(newValue) {
      const min = parseInt(quantityInput.min) || 1;
      const value = Math.max(min, parseInt(newValue) || min);
      quantityInput.value = value;
      
      // Update button disabled states
      decreaseBtn.disabled = value <= min;
      
      // Trigger input and change events
      quantityInput.dispatchEvent(new Event('input', { bubbles: true }));
      quantityInput.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // Initialize button states
    updateQuantity(quantityInput.value);

    // Decrease button
    decreaseBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const currentValue = parseInt(quantityInput.value) || 1;
      const min = parseInt(quantityInput.min) || 1;
      if (currentValue > min) {
        updateQuantity(currentValue - 1);
      }
    });

    // Increase button
    increaseBtn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      const currentValue = parseInt(quantityInput.value) || 1;
      updateQuantity(currentValue + 1);
    });

    // Validate input on manual entry
    quantityInput.addEventListener('blur', function() {
      const min = parseInt(this.min) || 1;
      const value = parseInt(this.value) || min;
      if (value < min) {
        this.value = min;
      }
      updateQuantity(this.value);
    });

    // Handle input changes
    quantityInput.addEventListener('input', function() {
      const min = parseInt(this.min) || 1;
      const value = parseInt(this.value) || min;
      if (this.value === '' || isNaN(parseInt(this.value))) {
        this.value = min;
      }
      updateQuantity(this.value);
    });

    // Prevent invalid input
    quantityInput.addEventListener('keydown', function(e) {
      // Allow: backspace, delete, tab, escape, enter, and decimal point
      if ([46, 8, 9, 27, 13, 110, 190].indexOf(e.keyCode) !== -1 ||
        // Allow: Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
        (e.keyCode === 65 && e.ctrlKey === true) ||
        (e.keyCode === 67 && e.ctrlKey === true) ||
        (e.keyCode === 86 && e.ctrlKey === true) ||
        (e.keyCode === 88 && e.ctrlKey === true) ||
        // Allow: home, end, left, right
        (e.keyCode >= 35 && e.keyCode <= 39)) {
        return;
      }
      // Ensure that it is a number and stop the keypress
      if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
        e.preventDefault();
      }
    });
  }

  // Tab switching functionality
  const tabsSection = productDetail.querySelector('[data-tabs-section]');
  if (tabsSection) {
    const tabs = tabsSection.querySelectorAll('.product-detail__tab');
    const tabPanels = tabsSection.querySelectorAll('.product-detail__tab-panel');

    for (const tab of tabs) {
      tab.addEventListener('click', function() {
        const targetTab = this.dataset.tab;
        const targetPanel = tabsSection.querySelector(`[data-tab-panel="${targetTab}"]`);
        
        if (!targetPanel) return;
        
        // Update tab active state and ARIA attributes
        tabs.forEach(t => {
          t.classList.remove('product-detail__tab--active');
          t.setAttribute('aria-selected', 'false');
        });
        this.classList.add('product-detail__tab--active');
        this.setAttribute('aria-selected', 'true');
        
        // Update panel active state and ARIA attributes
        tabPanels.forEach(panel => {
          panel.classList.remove('product-detail__tab-panel--active');
          panel.setAttribute('aria-hidden', 'true');
        });
        targetPanel.classList.add('product-detail__tab-panel--active');
        targetPanel.setAttribute('aria-hidden', 'false');
        
        // Focus management for accessibility
        targetPanel.focus();
      });
      
      // Keyboard navigation support
      tab.addEventListener('keydown', function(e) {
        const currentIndex = Array.from(tabs).indexOf(this);
        let targetIndex = currentIndex;
        
        if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
          e.preventDefault();
          targetIndex = (currentIndex + 1) % tabs.length;
        } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
          e.preventDefault();
          targetIndex = (currentIndex - 1 + tabs.length) % tabs.length;
        } else if (e.key === 'Home') {
          e.preventDefault();
          targetIndex = 0;
        } else if (e.key === 'End') {
          e.preventDefault();
          targetIndex = tabs.length - 1;
        }
        
        if (targetIndex !== currentIndex) {
          tabs[targetIndex].click();
          tabs[targetIndex].focus();
        }
      });
    }
  }

  // Update price display
  function updatePrice(variant) {
    if (!variant) return;
    
    const priceEl = productDetail.querySelector('[data-price]');
    const comparePriceEl = productDetail.querySelector('[data-compare-price]');
    const badgeEl = productDetail.querySelector('[data-discount-badge]');
    const pricingContainer = productDetail.querySelector('[data-product-pricing]');
    
    if (priceEl && variant.priceFormatted) {
      priceEl.textContent = variant.priceFormatted;
    }
    
    if (pricingContainer) {
      pricingContainer.dataset.variantId = variant.id;
    }
    
    if (variant.compareAtPrice > variant.price) {
      const discount = Math.round(((variant.compareAtPrice - variant.price) / variant.compareAtPrice) * 100);
      
      if (comparePriceEl && variant.comparePriceFormatted) {
        comparePriceEl.textContent = variant.comparePriceFormatted;
        comparePriceEl.style.display = 'inline';
      }
      
      if (badgeEl) {
        badgeEl.textContent = discount + '% OFF';
        badgeEl.style.display = 'inline-block';
      }
    } else {
      if (comparePriceEl) comparePriceEl.style.display = 'none';
      if (badgeEl) badgeEl.style.display = 'none';
    }
  }

  // Update variant image
  function updateVariantImage(variant) {
    if (!variant || !mainImage) return;
    
    // If variant has a specific image, use it
    if (variant.imageUrl && variant.imageId) {
      mainImage.src = variant.imageUrl;
      const variantImage = productImages.find(img => img.id === variant.imageId);
      if (variantImage) {
        mainImage.alt = variantImage.alt || mainImage.alt;
        
        // Update thumbnail active state by matching image ID
        const matchingThumbnail = Array.from(thumbnails).find(thumb => {
          const thumbImageId = parseInt(thumb.dataset.imageId);
          return thumbImageId === variant.imageId;
        });
        
        if (matchingThumbnail) {
          thumbnails.forEach(t => t.classList.remove('product-detail__thumbnail--active'));
          matchingThumbnail.classList.add('product-detail__thumbnail--active');
        }
      }
    }
  }

  // Update variant availability
  function updateVariantAvailability(variant) {
    const addToCartBtn = productDetail.querySelector('[data-add-to-cart]');
    const buyNowBtn = productDetail.querySelector('[data-buy-now]');
    
    if (addToCartBtn) {
      addToCartBtn.dataset.variantId = variant.id;
      if (variant.available) {
        addToCartBtn.disabled = false;
        addToCartBtn.textContent = 'Add to cart';
        addToCartBtn.classList.remove('product-detail__btn--loading');
      } else {
        addToCartBtn.disabled = true;
        addToCartBtn.textContent = 'Sold out';
        addToCartBtn.classList.remove('product-detail__btn--loading');
      }
    }
    
    if (buyNowBtn) {
      buyNowBtn.dataset.variantId = variant.id;
      buyNowBtn.disabled = !variant.available;
      buyNowBtn.classList.remove('product-detail__btn--loading');
    }
  }

  // Find variant based on selected options
  function findVariantFromOptions() {
    const selectedOptions = {};
    const optionButtons = productDetail.querySelectorAll('.product-detail__option-value.product-detail__option-value--active');
    
    // Collect all selected options
    for (const button of optionButtons) {
      const position = parseInt(button.dataset.optionPosition);
      const value = button.dataset.optionValue;
      selectedOptions[position] = value;
    }
    
    // Check if we have all required options selected
    const totalOptions = productDetail.querySelectorAll('.product-detail__options').length;
    if (Object.keys(selectedOptions).length < totalOptions) {
      // Not all options selected, return null to indicate incomplete selection
      return null;
    }
    
    // Find matching variant - all options must match exactly
    for (const variantId in variantData) {
      const variant = variantData[variantId];
      let match = true;
      
      for (let i = 0; i < variant.options.length; i++) {
        if (selectedOptions[i] !== variant.options[i]) {
          match = false;
          break;
        }
      }
      
      if (match) {
        return variant;
      }
    }
    
    // No exact match found, return current variant as fallback
    return variantData[currentVariantId] || Object.values(variantData)[0];
  }

  // Option selection handler - handle all product options
  const optionButtons = productDetail.querySelectorAll('.product-detail__option-value');
  for (const option of optionButtons) {
    option.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation(); // Prevent theme.js from handling this
      
      if (this.disabled) return;
      
      const optionPosition = parseInt(this.dataset.optionPosition);
      const samePositionOptions = productDetail.querySelectorAll(`[data-option-position="${optionPosition}"]`);
      
      // Update active state for same position options
      samePositionOptions.forEach(o => o.classList.remove('product-detail__option-value--active'));
      this.classList.add('product-detail__option-value--active');
      
      // Find and update to new variant
      const newVariant = findVariantFromOptions();
      if (newVariant && newVariant.id !== currentVariantId) {
        currentVariantId = newVariant.id;
        updatePrice(newVariant);
        updateVariantAvailability(newVariant);
        updateVariantImage(newVariant);
      } else if (!newVariant) {
        // Incomplete selection - disable buttons
        const addToCartBtn = productDetail.querySelector('[data-add-to-cart]');
        const buyNowBtn = productDetail.querySelector('[data-buy-now]');
        if (addToCartBtn) addToCartBtn.disabled = true;
        if (buyNowBtn) buyNowBtn.disabled = true;
      }
    });
  }

  // Update cart count in header
  function updateCartCount() {
    fetch('/cart.js')
      .then(response => response.json())
      .then(cart => {
        const cartCount = cart.item_count || 0;
        const cartCountElements = document.querySelectorAll('[data-cart-count]');
        for (const element of cartCountElements) {
          element.textContent = cartCount;
        }
      })
      .catch(error => {
        console.error('Error fetching cart count:', error);
      });
  }

  // Add to cart functionality
  const addToCartBtn = productDetail.querySelector('[data-add-to-cart]');
  if (addToCartBtn) {
    addToCartBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation(); // Prevent theme.js from handling this
      
      if (this.disabled || this.classList.contains('product-detail__btn--loading')) return;
      
      const variantIdStr = this.dataset.variantId;
      if (!variantIdStr) {
        alert('Please select a variant');
        return;
      }
      
      const variantId = parseInt(variantIdStr, 10);
      if (isNaN(variantId) || variantId <= 0) {
        console.error('Invalid variant ID:', variantIdStr);
        alert('Invalid product variant. Please try again.');
        return;
      }
      
      const quantity = quantityInput ? Math.max(1, parseInt(quantityInput.value) || 1) : 1;
      
      // Show loading state
      const originalText = this.textContent;
      this.disabled = true;
      this.classList.add('product-detail__btn--loading');
      this.textContent = 'Adding...';
      
      try {
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [{
              id: variantId,
              quantity: quantity
            }]
          })
        });
        
        if (response.ok) {
          const data = await response.json();
          
          // Update cart count
          updateCartCount();
          
          // Trigger cart update event for other components
          document.dispatchEvent(new CustomEvent('cart:updated', {
            detail: { cart: data }
          }));
          
          // Open cart drawer or redirect to cart page
          const header = document.querySelector('.header');
          const cartType = header?.getAttribute('data-cart-type') || 'drawer';
          const cartDrawer = window.theme?.cartDrawer;
          
          if (cartType === 'drawer' && cartDrawer) {
            try {
              await cartDrawer.refreshCart();
              cartDrawer.open();
              // Show success feedback
              this.textContent = 'Added!';
              setTimeout(() => {
                this.textContent = originalText;
                this.disabled = false;
                this.classList.remove('product-detail__btn--loading');
              }, 1000);
            } catch (drawerError) {
              console.error('Error opening cart drawer:', drawerError);
              // Fallback to redirect if drawer fails
              window.location.href = '/cart';
            }
          } else {
            // Redirect to cart page if drawer is disabled
            window.location.href = '/cart';
          }
        } else {
          const errorData = await response.json().catch(() => ({}));
          let errorMessage = errorData.description || 'Failed to add to cart';
          
          // Provide user-friendly error messages for common scenarios
          if (response.status === 422) {
            const errorLower = errorMessage.toLowerCase();
            if (errorLower.includes('sold out') || errorLower.includes('already sold out')) {
              errorMessage = 'Sorry, this product is currently sold out.';
            } else if (errorLower.includes('inventory') || errorLower.includes('quantity')) {
              errorMessage = 'Sorry, the requested quantity is not available.';
            } else if (errorLower.includes('unavailable')) {
              errorMessage = 'Sorry, this product is currently unavailable.';
            }
          }
          
          throw new Error(errorMessage);
        }
      } catch (error) {
        console.error('Error adding to cart:', error);
        const userMessage = error.message || 'Failed to add item to cart. Please try again.';
        alert(userMessage);
        this.textContent = originalText;
        this.disabled = false;
        this.classList.remove('product-detail__btn--loading');
      }
    });
  }

  // Buy now functionality
  const buyNowBtn = productDetail.querySelector('[data-buy-now]');
  if (buyNowBtn) {
    buyNowBtn.addEventListener('click', async function(e) {
      e.preventDefault();
      e.stopPropagation(); // Prevent theme.js from handling this
      
      if (this.disabled || this.classList.contains('product-detail__btn--loading')) return;
      
      const variantIdStr = this.dataset.variantId;
      if (!variantIdStr) {
        alert('Please select a variant');
        return;
      }
      
      const variantId = parseInt(variantIdStr, 10);
      if (isNaN(variantId) || variantId <= 0) {
        console.error('Invalid variant ID:', variantIdStr);
        alert('Invalid product variant. Please try again.');
        return;
      }
      
      const quantity = quantityInput ? Math.max(1, parseInt(quantityInput.value) || 1) : 1;
      
      // Show loading state
      const originalText = this.textContent;
      this.disabled = true;
      this.classList.add('product-detail__btn--loading');
      this.textContent = 'Adding...';
      
      try {
        // Add to cart first
        const response = await fetch('/cart/add.js', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            items: [{
              id: variantId,
              quantity: quantity
            }]
          })
        });
        
        if (response.ok) {
          // Update cart count
          updateCartCount();
          
          // Redirect to checkout
          window.location.href = '/checkout';
        } else {
          const errorData = await response.json().catch(() => ({}));
          let errorMessage = errorData.description || 'Failed to add to cart';
          
          // Provide user-friendly error messages for common scenarios
          if (response.status === 422) {
            const errorLower = errorMessage.toLowerCase();
            if (errorLower.includes('sold out') || errorLower.includes('already sold out')) {
              errorMessage = 'Sorry, this product is currently sold out.';
            } else if (errorLower.includes('inventory') || errorLower.includes('quantity')) {
              errorMessage = 'Sorry, the requested quantity is not available.';
            } else if (errorLower.includes('unavailable')) {
              errorMessage = 'Sorry, this product is currently unavailable.';
            }
          }
          
          throw new Error(errorMessage);
        }
      } catch (error) {
        console.error('Error in buy now:', error);
        const userMessage = error.message || 'Failed to proceed to checkout. Please try again.';
        alert(userMessage);
        this.textContent = originalText;
        this.disabled = false;
        this.classList.remove('product-detail__btn--loading');
      }
    });
  }

  // Initialize variant image on page load (after all functions are defined)
  const initialVariant = variantData[currentVariantId];
  if (initialVariant && mainImage) {
    updateVariantImage(initialVariant);
  }
})();
{% endjavascript %}

{% schema %}
{
  "name": "Product Detail",
  "tag": "section",
  "class": "product-detail-section",
  "settings": [
    {
      "type": "product",
      "id": "product",
      "label": "Product",
      "info": "Select a product to display. If not selected, the first available product will be shown."
    },
    {
      "type": "header",
      "content": "Tabs"
    },
    {
      "type": "checkbox",
      "id": "show_tabs",
      "label": "Show tabs",
      "default": true
    }
  ],
  "blocks": [
    {
      "type": "tab",
      "name": "Tab",
      "settings": [
        {
          "type": "text",
          "id": "tab_label",
          "label": "Label",
          "default": "Tab"
        },
        {
          "type": "text",
          "id": "tab_id",
          "label": "ID",
          "info": "Unique identifier for this tab (auto-generated if empty)"
        },
        {
          "type": "select",
          "id": "tab_type",
          "label": "Type",
          "options": [
            {
              "value": "description",
              "label": "Description"
            },
            {
              "value": "specifications",
              "label": "Specifications"
            },
            {
              "value": "custom",
              "label": "Custom"
            }
          ],
          "default": "description"
        },
        {
          "type": "richtext",
          "id": "fallback_content",
          "label": "Fallback content",
          "info": "Shown when product description is empty (Description type only)"
        },
        {
          "type": "richtext",
          "id": "specifications_content",
          "label": "Content",
          "info": "Custom specifications content (Specifications type only). Leave empty to show product details automatically."
        },
        {
          "type": "richtext",
          "id": "custom_content",
          "label": "Content",
          "info": "Custom tab content (Custom type only)"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Detail",
      "blocks": [
        {
          "type": "tab",
          "settings": {
            "tab_label": "Description",
            "tab_type": "description"
          }
        },
        {
          "type": "tab",
          "settings": {
            "tab_label": "Specifications",
            "tab_type": "specifications"
          }
        }
      ]
    }
  ]
}
{% endschema %}

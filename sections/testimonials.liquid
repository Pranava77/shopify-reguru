{%- liquid
  assign heading = section.settings.heading | default: 'Testimonials'
  assign bg_color = section.settings.background_color | default: '#B1D8FF'
  assign visible_cards = section.settings.visible_cards | default: 3
  assign total_blocks = section.blocks.size
  if total_blocks == 0
    assign total_blocks = 3
  endif
-%}

<section class="testimonials" style="--testimonials-bg: {{ bg_color }};" id="testimonials-{{ section.id }}">
  <div class="testimonials__container">
    <div class="testimonials__header">
      <h2 class="testimonials__title">{{ heading }}</h2>
    </div>

    <div class="testimonials__slider" data-testimonials-slider>
      <div class="testimonials__track" data-testimonials-track>
        {%- for block in section.blocks -%}
          {%- render 'testimonial-card',
            name: block.settings.name,
            quote: block.settings.quote,
            image: block.settings.image
          -%}
        {%- endfor -%}

        {%- if section.blocks.size == 0 -%}
          {%- assign default_testimonials = 'Ashok Kumar|Priyanka Sharma|Gopal Krishna' | split: '|' -%}
          {%- for person in default_testimonials -%}
            <article class="testimonial-card card">
              <div class="testimonial-card__quote-bg"></div>
              <div class="testimonial-card__content">
                <div class="testimonial-card__avatar">
                  <div class="testimonial-card__avatar-placeholder">
                    <svg viewBox="0 0 80 112" fill="none" xmlns="http://www.w3.org/2000/svg">
                      <rect width="80" height="112" rx="10" fill="#E0E0E0"/>
                      <circle cx="40" cy="35" r="20" fill="#B0B0B0"/>
                      <ellipse cx="40" cy="85" rx="30" ry="25" fill="#B0B0B0"/>
                    </svg>
                  </div>
                </div>
                <div class="testimonial-card__divider"></div>
                <div class="testimonial-card__text">
                  <h3 class="testimonial-card__name">{{ person }}</h3>
                  <p class="testimonial-card__quote">"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus sit amet mi nec massa tincidunt"</p>
                </div>
              </div>
              <div class="testimonial-card__icon">
                <svg width="34" height="32" viewBox="0 0 34 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M8 16L16 0H10L2 16V32H18V16H8Z" fill="#5294FF"/>
                  <path d="M24 16L32 0H26L18 16V32H34V16H24Z" fill="#5294FF"/>
                </svg>
              </div>
            </article>
          {%- endfor -%}
        {%- endif -%}
      </div>
    </div>

    <div class="testimonials__controls">
      <div class="testimonials__nav">
        <button 
          type="button" 
          class="testimonials__nav-btn btn btn--icon btn--blue" 
          data-testimonials-prev 
          aria-label="Previous testimonials"
          {% if total_blocks <= visible_cards %}disabled{% endif %}
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <button 
          type="button" 
          class="testimonials__nav-btn btn btn--icon btn--blue" 
          data-testimonials-next 
          aria-label="Next testimonials"
          {% if total_blocks <= visible_cards %}disabled{% endif %}
        >
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>

      {%- if total_blocks > visible_cards -%}
        <div class="testimonials__pagination" data-testimonials-pagination>
          {%- assign max_slides = total_blocks | minus: visible_cards | plus: 1 -%}
          {%- for i in (1..max_slides) -%}
            <button 
              class="testimonials__dot{% if forloop.first %} testimonials__dot--active{% endif %}" 
              data-slide-index="{{ forloop.index0 }}"
              aria-label="Go to slide {{ forloop.index }}"
            ></button>
          {%- endfor -%}
        </div>
      {%- endif -%}
    </div>
  </div>
</section>

<script>
  (function() {
    const section = document.getElementById('testimonials-{{ section.id }}');
    if (!section) return;

    const slider = section.querySelector('[data-testimonials-slider]');
    const track = section.querySelector('[data-testimonials-track]');
    const prevBtn = section.querySelector('[data-testimonials-prev]');
    const nextBtn = section.querySelector('[data-testimonials-next]');
    const pagination = section.querySelector('[data-testimonials-pagination]');
    const cards = track.querySelectorAll('.testimonial-card');

    if (cards.length === 0) return;

    let currentIndex = 0;
    let visibleCards = {{ visible_cards }};
    const totalCards = cards.length;
    const gap = 25; // Gap between cards in pixels

    // Calculate how many cards to show based on screen size
    const getVisibleCards = () => {
      if (window.innerWidth <= 768) return 1;
      if (window.innerWidth <= 992) return 2;
      return {{ visible_cards }};
    };

    // Calculate card width including gap
    const getCardWidth = () => {
      const card = cards[0];
      if (!card) return 0;
      return card.offsetWidth + gap;
    };

    // Calculate maximum slide index
    const getMaxIndex = () => {
      visibleCards = getVisibleCards();
      return Math.max(0, totalCards - visibleCards);
    };

    // Update track position
    const updateTrackPosition = () => {
      const cardWidth = getCardWidth();
      const offset = currentIndex * cardWidth;
      track.style.transform = `translateX(-${offset}px)`;
    };

    // Update button states
    const updateButtonStates = () => {
      const maxIndex = getMaxIndex();
      
      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex >= maxIndex;

      prevBtn.classList.toggle('testimonials__nav-btn--disabled', currentIndex === 0);
      nextBtn.classList.toggle('testimonials__nav-btn--disabled', currentIndex >= maxIndex);
    };

    // Update pagination dots
    const updatePagination = () => {
      if (!pagination) return;
      
      const dots = pagination.querySelectorAll('.testimonials__dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('testimonials__dot--active', index === currentIndex);
      });
    };

    // Go to specific slide
    const goToSlide = (index) => {
      const maxIndex = getMaxIndex();
      currentIndex = Math.max(0, Math.min(index, maxIndex));
      updateTrackPosition();
      updateButtonStates();
      updatePagination();
    };

    // Previous slide
    const prevSlide = () => {
      if (currentIndex > 0) {
        goToSlide(currentIndex - 1);
      }
    };

    // Next slide
    const nextSlide = () => {
      const maxIndex = getMaxIndex();
      if (currentIndex < maxIndex) {
        goToSlide(currentIndex + 1);
      }
    };

    // Event listeners
    prevBtn.addEventListener('click', prevSlide);
    nextBtn.addEventListener('click', nextSlide);

    // Pagination dot clicks
    if (pagination) {
      const dots = pagination.querySelectorAll('.testimonials__dot');
      dots.forEach((dot) => {
        dot.addEventListener('click', () => {
          const index = parseInt(dot.dataset.slideIndex, 10);
          goToSlide(index);
        });
      });
    }

    // Touch/swipe support for mobile
    let touchStartX = 0;
    let touchEndX = 0;

    slider.addEventListener('touchstart', (e) => {
      touchStartX = e.changedTouches[0].screenX;
    }, { passive: true });

    slider.addEventListener('touchend', (e) => {
      touchEndX = e.changedTouches[0].screenX;
      handleSwipe();
    }, { passive: true });

    const handleSwipe = () => {
      const swipeThreshold = 50;
      const diff = touchStartX - touchEndX;

      if (Math.abs(diff) > swipeThreshold) {
        if (diff > 0) {
          // Swiped left - go next
          nextSlide();
        } else {
          // Swiped right - go prev
          prevSlide();
        }
      }
    };

    // Handle window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(() => {
        const maxIndex = getMaxIndex();
        if (currentIndex > maxIndex) {
          currentIndex = maxIndex;
        }
        updateTrackPosition();
        updateButtonStates();
      }, 100);
    });

    // Keyboard navigation
    section.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        prevSlide();
      } else if (e.key === 'ArrowRight') {
        nextSlide();
      }
    });

    // Initialize
    updateButtonStates();
    updatePagination();
  })();
</script>

{% stylesheet %}
.testimonials {
  padding: 60px 0;
  background-color: var(--testimonials-bg);
}

.testimonials__container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 33px;
  max-width: var(--container-max);
  margin: 0 auto;
  padding: 0 var(--container-padding);
}

.testimonials__header {
  text-align: center;
}

.testimonials__title {
  font-family: var(--font-heading);
  font-weight: 600;
  font-size: 49px;
  line-height: 1.1;
  color: var(--color-dark-blue);
  text-transform: capitalize;
  margin: 0;
}

.testimonials__slider {
  width: 100%;
  max-width: 1281px;
  overflow: hidden;
}

.testimonials__track {
  display: flex;
  gap: 25px;
  transition: transform 0.4s cubic-bezier(0.25, 0.1, 0.25, 1);
}

.testimonials__controls {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 20px;
}

.testimonials__nav {
  display: flex;
  gap: 24px;
  align-items: center;
}

.testimonials__nav-btn {
  width: 32px;
  height: 32px;
  padding: 8px;
  background-color: var(--color-blue);
  border: 1px solid var(--color-black);
  border-radius: var(--radius-sm);
  box-shadow: var(--shadow-sm);
  color: var(--color-black);
  cursor: pointer;
  transition: transform var(--transition-fast), box-shadow var(--transition-fast), opacity var(--transition-fast);
  display: flex;
  align-items: center;
  justify-content: center;
}

.testimonials__nav-btn:hover:not(:disabled) {
  transform: translate(-1px, -1px);
  box-shadow: 3px 3px 0px 0px var(--color-black);
}

.testimonials__nav-btn:active:not(:disabled) {
  transform: translate(1px, 1px);
  box-shadow: 1px 1px 0px 0px var(--color-black);
}

.testimonials__nav-btn:disabled,
.testimonials__nav-btn--disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.testimonials__nav-btn svg {
  width: 16px;
  height: 16px;
}

.testimonials__pagination {
  display: flex;
  gap: 10px;
  align-items: center;
}

.testimonials__dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background-color: var(--color-navy);
  opacity: 0.3;
  border: none;
  padding: 0;
  cursor: pointer;
  transition: opacity 0.3s ease, transform 0.3s ease, background-color 0.3s ease;
}

.testimonials__dot--active {
  opacity: 1;
  transform: scale(1.3);
  background-color: var(--color-dark-blue);
}

.testimonials__dot:hover:not(.testimonials__dot--active) {
  opacity: 0.6;
}

.testimonials__dot:focus {
  outline: 2px solid var(--color-accent);
  outline-offset: 2px;
}

@media screen and (max-width: 992px) {
  .testimonials__title {
    font-size: 36px;
  }

  .testimonials__track {
    gap: 16px;
  }
}

@media screen and (max-width: 768px) {
  .testimonials {
    padding: 40px 0;
  }

  .testimonials__title {
    font-size: 28px;
  }

  .testimonials__track {
    gap: 20px;
  }

  .testimonials__controls {
    gap: 16px;
  }

  .testimonials__nav {
    gap: 16px;
  }

  .testimonials__dot {
    width: 8px;
    height: 8px;
  }
}
{% endstylesheet %}

{% schema %}
{
  "name": "Testimonials",
  "tag": "section",
  "class": "testimonials-section",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Testimonials"
    },
    {
      "type": "color",
      "id": "background_color",
      "label": "Background Color",
      "default": "#B1D8FF"
    },
    {
      "type": "range",
      "id": "visible_cards",
      "min": 1,
      "max": 4,
      "step": 1,
      "label": "Visible Cards (Desktop)",
      "default": 3
    }
  ],
  "blocks": [
    {
      "type": "testimonial",
      "name": "Testimonial",
      "settings": [
        {
          "type": "text",
          "id": "name",
          "label": "Name",
          "default": "Customer Name"
        },
        {
          "type": "textarea",
          "id": "quote",
          "label": "Quote",
          "default": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus sit amet mi nec massa tincidunt"
        },
        {
          "type": "image_picker",
          "id": "image",
          "label": "Customer Image"
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Testimonials",
      "blocks": [
        {
          "type": "testimonial",
          "settings": {
            "name": "Ashok Kumar",
            "quote": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus sit amet mi nec massa tincidunt"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "name": "Priyanka Sharma",
            "quote": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus sit amet mi nec massa tincidunt"
          }
        },
        {
          "type": "testimonial",
          "settings": {
            "name": "Gopal Krishna",
            "quote": "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus sit amet mi nec massa tincidunt"
          }
        }
      ]
    }
  ]
}
{% endschema %}
